<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ì‚° ë§›ì§‘ ì •ë³´</title>

  <!-- Kakao Maps JS SDK: ì•„ë˜ YOUR_KAKAO_APP_KEY ë¥¼ ë³¸ì¸ í‚¤ë¡œ êµì²´í•˜ì„¸ìš” -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=3ca8f8ca6e23307fccc79051a54d9f4a&libraries=services"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --card:#121420;
      --card2:#0f111a;
      --text:#e9ecf1;
      --muted:#a8b0c0;
      --line:rgba(255,255,255,.10);
      --accent:#ff4d4f;
      --accent2:#4ade80;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, "Helvetica Neue", Arial;
      color:var(--text);
      background:linear-gradient(180deg,#0b0c10 0%, #090a0f 100%);
      min-height:100vh;
    }

    .app{
      max-width:1180px;
      margin:0 auto;
      padding:18px;
    }

    .shell{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:stretch;
    }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: calc(100vh - 36px);
    }

    /* Left: list */
    .listHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.20);
      position:sticky;
      top:0;
      z-index:3;
      backdrop-filter: blur(10px);
    }

    .titleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .brand{
      font-weight:800;
      letter-spacing:-.02em;
      font-size:16px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.02);
    }

    .searchRow{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
    }

    .search input{
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }

    .iconBtn{
      width:42px;
      height:42px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition:.15s ease;
    }
    .iconBtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}

    .tabs{
      margin-top:10px;
      display:flex;
      gap:8px;
    }
    .tab{
      flex:1;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      font-size:13px;
      cursor:pointer;
      text-align:center;
      transition:.15s ease;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(255,77,79,.45);
      background:rgba(255,77,79,.12);
    }

    .listBody{
      height: calc(100vh - 36px);
      overflow:auto;
      padding:10px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid transparent;
      cursor:pointer;
      transition:.15s ease;
    }
    .row:hover{background:rgba(255,255,255,.03); border-color:var(--line)}
    .row.active{background:rgba(255,255,255,.05); border-color:rgba(255,77,79,.35)}

    .row h4{
      margin:0 0 6px;
      font-size:14px;
      letter-spacing:-.02em;
    }
    .meta{
      margin:0;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }

    .heart{
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      display:grid;
      place-items:center;
      background:rgba(255,255,255,.02);
      transition:.15s ease;
    }
    .heart.on{border-color:rgba(255,77,79,.45); background:rgba(255,77,79,.12)}
    .heart svg{width:18px; height:18px}

    .footerBar{
      position:sticky;
      bottom:0;
      background:rgba(0,0,0,.25);
      border-top:1px solid var(--line);
      padding:10px;
      backdrop-filter: blur(10px);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* Right: detail */
    .detailWrap{
      display:flex;
      flex-direction:column;
      height: calc(100vh - 36px);
    }

    .hero{
      position:relative;
      aspect-ratio: 16/9;
      background: linear-gradient(135deg, rgba(255,77,79,.18), rgba(74,222,128,.10));
      border-bottom:1px solid var(--line);
    }
    .hero img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      opacity:.92;
    }
    .hero .overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.75));
    }
    .heroTop{
      position:absolute;
      inset:0;
      padding:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .heroBadge{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .chip{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:var(--text);
      backdrop-filter: blur(6px);
    }

    .detailBody{
      padding:14px;
      overflow:auto;
    }

    .kv{
      display:grid;
      grid-template-columns: 96px 1fr;
      gap:10px 12px;
      align-items:start;
      margin:14px 0;
    }

    .k{
      color:var(--muted);
      font-size:12px;
      background:#000;
      padding:7px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      width:fit-content;
    }
    .v{
      font-size:14px;
      line-height:1.5;
      color:var(--text);
      margin-top:2px;
    }

    .callRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .cta{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      font-size:13px;
      cursor:pointer;
      display:flex;
      gap:8px;
      align-items:center;
    }

    #map{
      width:100%;
      height:280px;
      border-radius:14px;
      border:1px solid var(--line);
      overflow:hidden;
      margin-top:12px;
      background:rgba(255,255,255,.02);
    }

    .empty{
      padding:18px;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      color:var(--text);
      font-size:13px;
      box-shadow:var(--shadow);
      opacity:0;
      pointer-events:none;
      transition:.2s ease;
      z-index:50;
    }
    .toast.show{opacity:1; bottom:24px}

    @media (max-width: 980px){
      .shell{grid-template-columns: 1fr;}
      .panel{min-height:auto}
      .listBody{height:auto; max-height: 48vh;}
      .detailWrap{height:auto;}
      #map{height:240px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="shell">

      <!-- LEFT: LIST -->
      <section class="panel" aria-label="ë§›ì§‘ ëª©ë¡">
        <div class="listHeader">
          <div class="titleRow">
            <div class="brand">ë¶€ì‚° ë§›ì§‘ ì •ë³´</div>
            <div class="pill" id="statusPill">ì¤€ë¹„ ì¤‘</div>
          </div>

          <div class="searchRow">
            <div class="search" role="search">
              <span aria-hidden="true">ğŸ”</span>
              <input id="q" type="search" placeholder="ìƒí˜¸ëª…/ë©”ë‰´/ì£¼ì†Œ ê²€ìƒ‰" autocomplete="off" />
            </div>
            <button class="iconBtn" id="refreshBtn" title="ìƒˆë¡œê³ ì¹¨" aria-label="ìƒˆë¡œê³ ì¹¨">âŸ³</button>
          </div>

          <div class="tabs">
            <button class="tab active" id="tabAll">ì „ì²´</button>
            <button class="tab" id="tabFav">ì¦ê²¨ì°¾ê¸°</button>
          </div>
        </div>

        <div class="listBody" id="list"></div>

        <div class="footerBar">
          <button class="btn" id="prevBtn">ì´ì „</button>
          <div class="pill" id="pagePill">1 / 1</div>
          <button class="btn" id="nextBtn">ë‹¤ìŒ</button>
        </div>
      </section>

      <!-- RIGHT: DETAIL -->
      <section class="panel" aria-label="ìƒì„¸ ì •ë³´">
        <div class="detailWrap">
          <div class="hero" id="hero">
            <img id="heroImg" alt="" src="" style="display:none" />
            <div class="overlay"></div>
            <div class="heroTop">
              <div class="heroBadge">
                <span class="chip" id="heroTitle">ìƒì„¸ë³´ê¸°</span>
                <span class="chip" id="heroSub">ë¶€ì‚°ê´‘ì—­ì‹œ</span>
              </div>
              <button class="iconBtn" id="detailFavBtn" title="ì¦ê²¨ì°¾ê¸°" aria-label="ì¦ê²¨ì°¾ê¸°">â™¡</button>
            </div>
          </div>

          <div class="detailBody" id="detail">
            <div class="empty">
              ì™¼ìª½ ëª©ë¡ì—ì„œ ë§›ì§‘ì„ ì„ íƒí•˜ì„¸ìš”.<br/>
              <small>Tip: ê³µê³µë°ì´í„°í¬í„¸ ì„œë¹„ìŠ¤í‚¤/ì¹´ì¹´ì˜¤ ì•±í‚¤ë¥¼ ë„£ìœ¼ë©´ ì‹¤ë°ì´í„° + ì§€ë„ê¹Œì§€ ë™ì‘í•©ë‹ˆë‹¤.</small>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  /**
   * ë¶€ì‚° ë§›ì§‘ ì •ë³´ ì„œë¹„ìŠ¤ (Vanilla)
   * - API: https://apis.data.go.kr/6260000/FoodService
   * - ì§€ë„: Kakao Maps
   *
   * ì‚¬ìš© ë°©ë²•
   * 1) ì•„ë˜ SERVICE_KEYì— ê³µê³µë°ì´í„°í¬í„¸ "ì¸ì¦í‚¤(Decoding)" ê°’ì„ ë„£ìœ¼ì„¸ìš”.
   * 2) <head>ì˜ Kakao script appkey=YOUR_KAKAO_APP_KEY ë¥¼ ë³¸ì¸ í‚¤ë¡œ êµì²´í•˜ì„¸ìš”.
   */

  const CONFIG = {
    SERVICE_KEY: 'U3rjn1OQzoe833jk5RJokTl1sVFUmIQp7dGTZl0tcvNU7p2blLzjccSSgrAHQgyLYlBIm7Qt0wOFwQRvvG7h8Q==', // ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤(Decoding)
    BASE_URL: 'https://apis.data.go.kr/6260000/FoodService',
    PAGE_SIZE: 10,
    DEFAULT_REGION_HINT: 'ë¶€ì‚°'
  };

  // ---- DOM ----
  const elList = document.getElementById('list');
  const elDetail = document.getElementById('detail');
  const elQ = document.getElementById('q');
  const elPrev = document.getElementById('prevBtn');
  const elNext = document.getElementById('nextBtn');
  const elPagePill = document.getElementById('pagePill');
  const elStatus = document.getElementById('statusPill');
  const elRefresh = document.getElementById('refreshBtn');
  const elTabAll = document.getElementById('tabAll');
  const elTabFav = document.getElementById('tabFav');
  const elHeroTitle = document.getElementById('heroTitle');
  const elHeroSub = document.getElementById('heroSub');
  const elHeroImg = document.getElementById('heroImg');
  const elDetailFavBtn = document.getElementById('detailFavBtn');
  const elToast = document.getElementById('toast');

  // ---- State ----
  let rawItems = [];       // API/Mock ì „ì²´
  let viewItems = [];      // ê²€ìƒ‰/í•„í„° ì ìš© ê²°ê³¼
  let page = 1;
  let totalPages = 1;
  let activeId = null;
  let mode = 'all'; // all | fav

  // Kakao Map
  let map = null;
  let marker = null;
  let geocoder = null;

  // ---- Utils ----
  const escapeHtml = (s='') => String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');

  const toast = (msg) => {
    elToast.textContent = msg;
    elToast.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(() => elToast.classList.remove('show'), 1500);
  };

  const uid = (it) => {
    // APIë§ˆë‹¤ ê³ ìœ í‚¤ëª…ì´ ë‹¤ë¥¼ ìˆ˜ ìˆì–´, ìƒí˜¸ëª…+ì£¼ì†Œ ê¸°ë°˜ìœ¼ë¡œ ì•ˆì •ì  í‚¤ ìƒì„±
    return btoa(unescape(encodeURIComponent(`${it.name||''}|${it.addr||''}|${it.tel||''}`))).slice(0, 24);
  };

  const favKey = 'busan_food_favorites_v1';
  const getFavs = () => {
    try { return new Set(JSON.parse(localStorage.getItem(favKey) || '[]')); }
    catch { return new Set(); }
  };
  const setFavs = (set) => localStorage.setItem(favKey, JSON.stringify([...set]));

  const iconHeart = (on=false) => on
    ? `<svg viewBox="0 0 24 24" fill="${'currentColor'}" aria-hidden="true"><path d="M12 21s-7.2-4.35-9.6-8.55C.48 8.94 2.7 6 6 6c1.74 0 3.35.81 4.4 2.09C11.65 6.81 13.26 6 15 6c3.3 0 5.52 2.94 3.6 6.45C19.2 16.65 12 21 12 21z"/></svg>`
    : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M12 21s-7.2-4.35-9.6-8.55C.48 8.94 2.7 6 6 6c1.74 0 3.35.81 4.4 2.09C11.65 6.81 13.26 6 15 6c3.3 0 5.52 2.94 3.6 6.45C19.2 16.65 12 21 12 21z"/></svg>`;

  // ---- Data mapping ----
  function normalizeApiItem(x){
    // FoodService ì‘ë‹µ í•„ë“œê°€ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ì¶”ì • ë§¤í•‘
    // ê°€ëŠ¥í•œ ê°’ë“¤ì„ ìµœëŒ€í•œ í¡ìˆ˜
    const name = x.MAIN_TITLE || x.title || x.MAINTITLE || x.ìƒí˜¸ëª… || x.ì—…ì†Œëª… || x.name || '';
    const addr = x.ADDR1 || x.ADDR || x.ADDRESS || x.addr1 || x.ì£¼ì†Œ || x.addr || '';
    const tel  = x.CNTCT_TEL || x.TEL || x.PHONE || x.ì „í™”ë²ˆí˜¸ || x.tel || '';
    const menu = x.RPRSNTV_MENU || x.MENU || x.MAIN_MENU || x.ëŒ€í‘œë©”ë‰´ || x.menu || '';
    const intro = x.ITEMCNTNTS || x.DETAIL || x.ì†Œê°œ || x.intro || '';
    const hours = x.USAGE_DAY_WEEK_AND_TIME || x.OPERTIME || x.ìš´ì˜ì‹œê°„ || x.hours || '';
    const homepage = x.HOMEPAGE_URL || x.HOMEPAGE || x.í™ˆí˜ì´ì§€ || x.homepage || '';
    const lat = Number(x.LAT || x.LATITUDE || x.mapY || x.ìœ„ë„ || x.lat || NaN);
    const lng = Number(x.LNG || x.LONGITUDE || x.mapX || x.ê²½ë„ || x.lng || NaN);
    const img = x.MAIN_IMG_NORMAL || x.MAIN_IMG_THUMB || x.ì´ë¯¸ì§€ || x.img || '';

    return {
      name, addr, tel, menu, intro, hours, homepage,
      lat: Number.isFinite(lat) ? lat : null,
      lng: Number.isFinite(lng) ? lng : null,
      img
    };
  }

  // ---- API ----
  async function fetchFoodList(){
    // FoodServiceëŠ” ë³´í†µ list endpointê°€ ì—¬ëŸ¬ ê°œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    // ì¼ë‹¨ "getFoodKr" í˜•íƒœ/"FoodKr" ê°™ì€ ì¼€ì´ìŠ¤ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
    // ì—¬ëŸ¬ í›„ë³´ë¥¼ ìˆœì°¨ ì‹œë„í•©ë‹ˆë‹¤.

    const candidates = [
      `${CONFIG.BASE_URL}/getFoodKr`,
      `${CONFIG.BASE_URL}/getFoodKrList`,
      `${CONFIG.BASE_URL}/getFoodService`,
      `${CONFIG.BASE_URL}`
    ];

    const params = new URLSearchParams({
      serviceKey: CONFIG.SERVICE_KEY,
      pageNo: '1',
      numOfRows: '100',
      resultType: 'json'
    });

    for (const url of candidates){
      try{
        const res = await fetch(`${url}?${params.toString()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();

        // ê³µê³µë°ì´í„° ì‘ë‹µ êµ¬ì¡°ê°€ ë‹¤ì–‘í•´ì„œ items ë°°ì—´ì„ íƒìƒ‰
        const items =
          json?.getFoodKr?.item ||
          json?.getFoodKr?.items ||
          json?.response?.body?.items?.item ||
          json?.response?.body?.items ||
          json?.body?.items?.item ||
          json?.items ||
          json?.data ||
          null;

        if (!items) throw new Error('items not found');

        const arr = Array.isArray(items) ? items : (items?.item ? items.item : []);
        const mapped = arr.map(normalizeApiItem).filter(it => it.name || it.addr);
        if (mapped.length) return mapped;

      }catch(err){
        // ë‹¤ìŒ í›„ë³´ ì‹œë„
      }
    }

    // ì‹¤íŒ¨ ì‹œ mock
    throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨ (ì„œë¹„ìŠ¤í‚¤/ì—”ë“œí¬ì¸íŠ¸/CORS í™•ì¸ í•„ìš”)');
  }

  // ---- Mock ----
  function getMock(){
    return [
      {
        name:'ë§Œë“œë¦¬ê³¤ë“œë ˆë°¥',
        addr:'ê°•ì„œêµ¬ ê³µí•­ì•ê¸¸ 85ë²ˆê¸¸ 13',
        menu:'ëŒì†¥ê³¤ë“œë ˆì •ì‹, ë‹¨í˜¸ë°•ì˜¤ë¦¬í›ˆì œ',
        tel:'051-941-3669',
        hours:'11:00-21:00 (20:00 ë¼ìŠ¤íŠ¸ì˜¤ë”)',
        intro:'ìƒ ê³¤ë“œë ˆë‚˜ë¬¼ì„ ì‚¬ìš©í•´ ëŒì†¥ë°¥ì„ ë§Œë“¤ê³ , ëœì¥ì°Œê°œì™€ ë‹¤ì–‘í•œ ë°˜ì°¬ì´ í•¨ê»˜ ì œê³µë˜ëŠ” ëŒì†¥ê³¤ë“œë ˆì •ì‹ì´ ì¸ê¸°ì…ë‹ˆë‹¤.',
        img:'',
        lat:null,
        lng:null,
        homepage:''
      },
      {
        name:'ë¯¼ë¬¼ê°€ë“ ',
        addr:'ê°•ì„œêµ¬ ëˆŒì°¨ì¤‘ì•™ê¸¸5(ëˆŒë¦¼ë™)',
        menu:'ìœ¡ì˜»ì§„í™ì–´ì¡°ë¦¼, ë¶•ì–´ì°œ',
        tel:'',
        hours:'',
        intro:'',
        img:'',
        lat:null,
        lng:null,
        homepage:''
      },
      {
        name:'ê°€ì•¼í• ë§¤ë°€ë©´',
        addr:'ë¶€ì‚° ì—°ì œêµ¬ ì›”ë“œì»µëŒ€ë¡œ 145ë²ˆê¸¸ 32',
        menu:'ë¬¼ë°€ë©´, ë¹„ë¹”ë°€ë©´',
        tel:'',
        hours:'',
        intro:'',
        img:'',
        lat:null,
        lng:null,
        homepage:''
      },
      {
        name:'êµ­ì œë°€ë©´ë³¸ì ',
        addr:'ì—°ì œêµ¬ ì¤‘ì•™ëŒ€ë¡œ1235ë²ˆê¸¸ 23-6',
        menu:'ë¬¼ë°€ë©´, ë¹„ë¹”ë°€ë©´',
        tel:'',
        hours:'',
        intro:'',
        img:'',
        lat:null,
        lng:null,
        homepage:''
      },
      {
        name:'ê±°ì¸í†µë‹­',
        addr:'ì¤‘êµ¬ ì¤‘êµ¬ë¡œ47ë²ˆê¸¸34',
        menu:'í›„ë¼ì´ë“œì¹˜í‚¨',
        tel:'',
        hours:'',
        intro:'',
        img:'',
        lat:null,
        lng:null,
        homepage:''
      },
      {
        name:'ë¶€ì‚°ê³°ì¥ì–´ë§›ì§‘ ì„±ì¼ì§‘',
        addr:'ì¤‘êµ¬ ëŒ€êµë¡œ 103',
        menu:'ì†Œê¸ˆêµ¬ì´, ì–‘ë…êµ¬ì´',
        tel:'',
        hours:'',
        intro:'',
        img:'',
        lat:null,
        lng:null,
        homepage:''
      }
    ];
  }

  // ---- Render list + pagination ----
  function computeView(){
    const q = elQ.value.trim().toLowerCase();
    const favs = getFavs();

    let arr = rawItems.slice();

    if (mode === 'fav'){
      arr = arr.filter(it => favs.has(uid(it)));
    }

    if (q){
      arr = arr.filter(it =>
        (it.name||'').toLowerCase().includes(q) ||
        (it.addr||'').toLowerCase().includes(q) ||
        (it.menu||'').toLowerCase().includes(q)
      );
    }

    viewItems = arr;
    totalPages = Math.max(1, Math.ceil(viewItems.length / CONFIG.PAGE_SIZE));
    page = Math.min(page, totalPages);

    elPagePill.textContent = `${page} / ${totalPages}`;
    elPrev.disabled = (page <= 1);
    elNext.disabled = (page >= totalPages);

    renderList();
  }

  function renderList(){
    const favs = getFavs();
    const start = (page - 1) * CONFIG.PAGE_SIZE;
    const slice = viewItems.slice(start, start + CONFIG.PAGE_SIZE);

    if (!slice.length){
      elList.innerHTML = `<div class="empty">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }

    elList.innerHTML = slice.map(it => {
      const id = uid(it);
      const on = favs.has(id);
      const active = (activeId === id);
      return `
        <div class="row ${active ? 'active' : ''}" data-id="${id}">
          <div>
            <h4>${escapeHtml(it.name || 'ì´ë¦„ ì—†ìŒ')}</h4>
            <p class="meta">ì£¼ì†Œ: ${escapeHtml(it.addr || '-')}</p>
            <p class="meta">ë©”ë‰´: ${escapeHtml(it.menu || '-')}</p>
          </div>
          <button class="heart ${on ? 'on' : ''}" data-heart="${id}" title="ì¦ê²¨ì°¾ê¸°" aria-label="ì¦ê²¨ì°¾ê¸°">
            ${iconHeart(on)}
          </button>
        </div>
      `;
    }).join('');
  }

  // ---- Detail ----
  function renderDetail(it){
    const id = uid(it);
    const favs = getFavs();
    const on = favs.has(id);

    elHeroTitle.textContent = it.name || 'ìƒì„¸ë³´ê¸°';
    elHeroSub.textContent = 'ë¶€ì‚°ê´‘ì—­ì‹œ';
    elDetailFavBtn.textContent = on ? 'â™¥' : 'â™¡';
    elDetailFavBtn.setAttribute('data-id', id);

    if (it.img){
      elHeroImg.src = it.img;
      elHeroImg.alt = it.name ? `${it.name} ì´ë¯¸ì§€` : 'ì´ë¯¸ì§€';
      elHeroImg.style.display = '';
    } else {
      elHeroImg.removeAttribute('src');
      elHeroImg.style.display = 'none';
    }

    elDetail.innerHTML = `
      <div class="kv">
        <div class="k">ìƒí˜¸ëª…</div>
        <div class="v"><strong>${escapeHtml(it.name || '-')}</strong></div>

        <div class="k">ì£¼ì†Œ</div>
        <div class="v">${escapeHtml(it.addr || '-')}</div>

        <div class="k">ì†Œê°œ</div>
        <div class="v">${escapeHtml(it.intro || 'ì†Œê°œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.')}</div>

        <div class="k">ëŒ€í‘œë©”ë‰´</div>
        <div class="v">${escapeHtml(it.menu || 'ë©”ë‰´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.')}</div>

        <div class="k">ë¬¸ì˜</div>
        <div class="v">${it.tel ? `<a href="tel:${escapeHtml(it.tel)}" style="color:inherit">${escapeHtml(it.tel)}</a>` : 'ì „í™”ë²ˆí˜¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>

        <div class="k">ìš´ì˜ì‹œê°„</div>
        <div class="v">${escapeHtml(it.hours || 'ìš´ì˜ì‹œê°„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.')}</div>

        <div class="k">í™ˆí˜ì´ì§€</div>
        <div class="v">${it.homepage ? `<a href="${escapeHtml(it.homepage)}" target="_blank" rel="noopener" style="color:inherit">${escapeHtml(it.homepage)}</a>` : 'ê³µì‹ í™ˆí˜ì´ì§€ ì—†ìŒ'}</div>
      </div>

      <div class="callRow">
        <button class="cta" id="copyAddrBtn">ğŸ“‹ ì£¼ì†Œ ë³µì‚¬</button>
        <button class="cta" id="openKakaoBtn">ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µ ì—´ê¸°</button>
        <button class="cta" id="openNaverBtn">ğŸ” ë„¤ì´ë²„ ê²€ìƒ‰</button>
      </div>

      <div id="map" aria-label="ì§€ë„"></div>
    `;

    // actions
    document.getElementById('copyAddrBtn').onclick = async () => {
      try{
        await navigator.clipboard.writeText(it.addr || '');
        toast('ì£¼ì†Œë¥¼ ë³µì‚¬í–ˆì–´ìš”');
      }catch{
        toast('ë³µì‚¬ ì‹¤íŒ¨: HTTPS í™˜ê²½ì—ì„œë§Œ ì§€ì›ë  ìˆ˜ ìˆì–´ìš”');
      }
    };

    document.getElementById('openKakaoBtn').onclick = () => {
      const q = encodeURIComponent(`${it.name || ''} ${it.addr || ''}`.trim());
      window.open(`https://map.kakao.com/link/search/${q}`, '_blank', 'noopener');
    };

    document.getElementById('openNaverBtn').onclick = () => {
      const q = encodeURIComponent(`${it.name || ''} ${it.addr || ''}`.trim());
      window.open(`https://search.naver.com/search.naver?query=${q}`, '_blank', 'noopener');
    };

    // map
    drawMap(it);
  }

  // ---- Kakao Map ----
  function ensureMapReady(){
    if (!window.kakao || !kakao.maps){
      toast('ì¹´ì¹´ì˜¤ë§µ SDKë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. appkeyë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      return false;
    }

    if (!map){
      const container = document.getElementById('map');
      map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(35.1796, 129.0756),
        level: 6
      });
      marker = new kakao.maps.Marker({ position: map.getCenter() });
      marker.setMap(map);
      geocoder = new kakao.maps.services.Geocoder();
    }

    return true;
  }

  function drawMap(it){
    if (!ensureMapReady()) return;

    const setPos = (lat, lng) => {
      const pos = new kakao.maps.LatLng(lat, lng);
      map.setCenter(pos);
      marker.setPosition(pos);
    };

    // 1) lat/lng ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ
    if (it.lat && it.lng){
      setPos(it.lat, it.lng);
      return;
    }

    // 2) ì—†ìœ¼ë©´ ì£¼ì†Œ ì§€ì˜¤ì½”ë”©
    const addr = (it.addr || '').trim();
    if (!addr){
      toast('ì£¼ì†Œê°€ ì—†ì–´ ì§€ë„ì— í‘œì‹œí•  ìˆ˜ ì—†ì–´ìš”');
      return;
    }

    geocoder.addressSearch(addr, (result, status) => {
      if (status === kakao.maps.services.Status.OK && result?.[0]){
        const {y, x} = result[0];
        setPos(Number(y), Number(x));
      } else {
        // ê·¸ë˜ë„ ë¶€ì‚° ì¤‘ì‹¬ìœ¼ë¡œ
        toast('ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨: ë¶€ì‚° ì¤‘ì‹¬ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤');
        setPos(35.1796, 129.0756);
      }
    });
  }

  // ---- Events ----
  elList.addEventListener('click', (e) => {
    const heartBtn = e.target.closest('[data-heart]');
    if (heartBtn){
      e.stopPropagation();
      const id = heartBtn.getAttribute('data-heart');
      toggleFavById(id);
      computeView();
      // ìƒì„¸ê°€ í˜„ì¬ í•­ëª©ì´ë©´ ë²„íŠ¼ ìƒíƒœë„ ë™ê¸°í™”
      if (activeId === id) syncDetailFavBtn();
      return;
    }

    const row = e.target.closest('.row');
    if (!row) return;
    const id = row.getAttribute('data-id');
    selectById(id);
  });

  elDetailFavBtn.addEventListener('click', () => {
    const id = elDetailFavBtn.getAttribute('data-id');
    if (!id) return;
    toggleFavById(id);
    syncDetailFavBtn();
    computeView();
  });

  function syncDetailFavBtn(){
    const favs = getFavs();
    elDetailFavBtn.textContent = favs.has(activeId) ? 'â™¥' : 'â™¡';
  }

  function toggleFavById(id){
    const favs = getFavs();
    if (favs.has(id)){
      favs.delete(id);
      toast('ì¦ê²¨ì°¾ê¸° í•´ì œ');
    } else {
      favs.add(id);
      toast('ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€');
    }
    setFavs(favs);
  }

  function selectById(id){
    activeId = id;
    const it = rawItems.find(x => uid(x) === id) || viewItems.find(x => uid(x) === id);
    if (!it) return;
    renderDetail(it);
    computeView();
  }

  elQ.addEventListener('input', () => { page = 1; computeView(); });
  elPrev.addEventListener('click', () => { page = Math.max(1, page-1); computeView(); });
  elNext.addEventListener('click', () => { page = Math.min(totalPages, page+1); computeView(); });

  elRefresh.addEventListener('click', () => init(true));

  elTabAll.addEventListener('click', () => {
    mode = 'all';
    elTabAll.classList.add('active');
    elTabFav.classList.remove('active');
    page = 1;
    computeView();
  });

  elTabFav.addEventListener('click', () => {
    mode = 'fav';
    elTabFav.classList.add('active');
    elTabAll.classList.remove('active');
    page = 1;
    computeView();
  });

  // ---- Init ----
  async function init(forceReload=false){
    elStatus.textContent = 'ë¡œë”© ì¤‘â€¦';

    try{
      // ì´ë¯¸ ë¡œë”©í•œ ì  ìˆìœ¼ë©´ ìºì‹œ ì¬ì‚¬ìš©
      if (!rawItems.length || forceReload){
        rawItems = await fetchFoodList();
        elStatus.textContent = `API ${rawItems.length}ê°œ`;
      }
    }catch(err){
      // API ì‹¤íŒ¨ ì‹œ mock ì‚¬ìš©
      rawItems = getMock();
      elStatus.textContent = 'Mock ë°ì´í„°';

      // ë„ì›€ë§ í† ìŠ¤íŠ¸
      toast('API ì‹¤íŒ¨: ì„œë¹„ìŠ¤í‚¤/ì—”ë“œí¬ì¸íŠ¸/CORS í™•ì¸');
    }

    // í•­ìƒ ìµœì†Œ 10ê°œëŠ” ë³´ì´ë„ë¡(ìš”êµ¬ì‚¬í•­)
    // mockì´ 10 ë¯¸ë§Œì´ë©´ ë°˜ë³µí•´ì„œ ì±„ì›€
    while (rawItems.length < 10){
      rawItems = rawItems.concat(rawItems);
      rawItems = rawItems.slice(0, 10);
    }

    // ì´ˆê¸° ì„ íƒ
    computeView();
    if (!activeId && viewItems[0]){
      selectById(uid(viewItems[0]));
    }
  }

  init(false);
</script>
</body>
</html>
