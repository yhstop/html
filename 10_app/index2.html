<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¶€ì‚° ë§›ì§‘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- âœ… autoload=false ë¡œë“œ í›„ kakao.maps.load()ë¡œ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™” -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=723a28831bc100497d089cbc3a64e24f&autoload=false&libraries=services"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #f6f6f6; font-family: -apple-system, BlinkMacSystemFont; }
    header { padding: 16px; text-align: center; font-weight: 600; background: #fff; border-bottom: 1px solid #ddd; }
    .card { background: #fff; padding: 14px; border-bottom: 1px solid #eee; cursor: pointer; }
    .card h3 { font-size: 16px; margin-bottom: 6px; }
    .card p { font-size: 13px; color: #666; }
    .hidden { display: none; }
    .detail { background: #fff; }
    .section { padding: 14px; }
    .thumb { width: 100%; height: 220px; object-fit: cover; margin-bottom: 12px; }
    .title { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
    .rating { font-size: 14px; color: #ff9800; margin-left: 6px; }
    .info p { font-size: 14px; margin-bottom: 6px; }
    .divider { height: 10px; background: #f6f6f6; }
    #map { width: 100%; height: 260px; }
    .review { font-size: 13px; padding: 8px 0; border-bottom: 1px solid #eee; }
    textarea { width: 100%; height: 80px; padding: 8px; margin-top: 6px; }
    button { width: 100%; padding: 10px; margin-top: 6px; background: #000; color: #fff; border: none; }
    .back { cursor:pointer; color:#111; font-weight:600; }
    .errorBox { padding: 14px; color:#b00020; background:#fff; border-bottom:1px solid #eee; }
  </style>
</head>

<body>
<header id="header">ë¶€ì‚° ë§›ì§‘</header>

<main id="listView"></main>

<section id="detailView" class="hidden">
  <div id="map"></div>
  <div class="divider"></div>

  <div class="detail">
    <div class="section">
      <div class="back" onclick="goBack()">â† ë’¤ë¡œê°€ê¸°</div>
    </div>

    <div class="section" id="detailContent"></div>

    <div class="divider"></div>

    <div class="section">
      <h4>ë¦¬ë·°</h4>
      <div id="reviewList"></div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <h4>ë¦¬ë·° ì‘ì„±</h4>
      <textarea id="reviewInput" placeholder="ë¦¬ë·°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
      <button onclick="saveReview()">ë¦¬ë·° ë“±ë¡</button>
    </div>
  </div>
</section>

<script>
  const SERVICE_KEY = "64dfa8ddd0226789d625e94b0537771b1f1d70d23e68899d4914267475e8398d";
  const API_URL = "https://apis.data.go.kr/6260000/FoodService/getFoodKr";

  let foodData = [];
  let currentId = "";
  let kakaoReady = false;

  // âœ… ì¹´ì¹´ì˜¤ SDK ì¤€ë¹„
  if (window.kakao && kakao.maps) {
    kakao.maps.load(() => {
      kakaoReady = true;
    });
  } else {
    // SDK ìì²´ê°€ ë§‰íŒ ê²½ìš°(ë„ë©”ì¸ ë¯¸ë“±ë¡ ë“±)
    console.warn("ì¹´ì¹´ì˜¤ SDK ë¡œë“œ ì‹¤íŒ¨ ê°€ëŠ¥: ë„ë©”ì¸ ë“±ë¡/ë¡œì»¬ì„œë²„ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸");
  }

  // âœ… ì´ˆê¸° ë¡œë”©
  init();

  async function init() {
    const list = document.getElementById("listView");
    list.innerHTML = `<div class="card"><h3>ë¡œë”© ì¤‘...</h3><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</p></div>`;

    try {
      const url = `${API_URL}?serviceKey=${encodeURIComponent(SERVICE_KEY)}&pageNo=1&numOfRows=50&resultType=json`;
      const res = await fetch(url);
      const data = await res.json();

      foodData = (data && data.getFoodKr && Array.isArray(data.getFoodKr.item)) ? data.getFoodKr.item : [];
      if (foodData.length === 0) {
        list.innerHTML = `<div class="errorBox">ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. (API ì‘ë‹µ êµ¬ì¡°ê°€ ë‹¤ë¥´ê±°ë‚˜ í˜¸ì¶œì´ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆì–´ìš”)</div>`;
        return;
      }

      renderList();
    } catch (err) {
      console.error("API í˜¸ì¶œ ì‹¤íŒ¨:", err);
      list.innerHTML = `
        <div class="errorBox">
          ê³µê³µë°ì´í„° API í˜¸ì¶œì´ ë¸Œë¼ìš°ì €ì—ì„œ ì°¨ë‹¨ë˜ì—ˆì„ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤(CORS).
          <br/>í•´ê²°: í”„ë¡ì‹œ ì„œë²„ë¥¼ ë¶™ì´ê±°ë‚˜, ë¡œì»¬/ì„œë²„ í™˜ê²½ì—ì„œ ë°±ì—”ë“œë¥¼ í†µí•´ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
        </div>
      `;
    }
  }

  function renderList() {
    const list = document.getElementById("listView");
    list.innerHTML = "";

    foodData.forEach(item => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <h3>${escapeHtml(item.MAIN_TITLE || "ì´ë¦„ ì—†ìŒ")}</h3>
        <p>${escapeHtml(item.ADDR1 || "ì£¼ì†Œ ì •ë³´ ì—†ìŒ")}</p>
        <p>${escapeHtml(item.RPRSNTV_MENU || "ëŒ€í‘œ ë©”ë‰´ ì •ë³´ ì—†ìŒ")}</p>
      `;
      div.onclick = () => openDetail(item);
      list.appendChild(div);
    });
  }

  function openDetail(item) {
    currentId = item.UC_SEQ;

    document.getElementById("listView").classList.add("hidden");
    document.getElementById("detailView").classList.remove("hidden");
    document.getElementById("header").innerText = item.MAIN_TITLE || "ìƒì„¸";

    const rating = (Math.random() * 1.5 + 3).toFixed(1);

    document.getElementById("detailContent").innerHTML = `
      ${item.MAIN_IMG_NORMAL ? `<img class="thumb" src="${item.MAIN_IMG_NORMAL}" alt="">` : ""}
      <div class="title">
        ${escapeHtml(item.MAIN_TITLE || "")}
        <span class="rating">â­ ${rating}</span>
      </div>
      <div class="info">
        <p>ğŸ“ ${escapeHtml(item.ADDR1 || "ì •ë³´ ì—†ìŒ")}</p>
        <p>ğŸ“ ${escapeHtml(item.CNTCT_TEL || "ì •ë³´ ì—†ìŒ")}</p>
        <p>â° ${escapeHtml(item.USAGE_DAY_WEEK_AND_TIME || "ì •ë³´ ì—†ìŒ")}</p>
      </div>
    `;

    loadReviews();

    // âœ… ì§€ë„ ê·¸ë¦¬ê¸°: í™”ë©´ ì „í™˜ í›„ relayout í•„ìš”
    setTimeout(() => {
      drawMap(item.LAT, item.LNG);
    }, 0);
  }

  function drawMap(lat, lng) {
    const mapContainer = document.getElementById("map");
    mapContainer.innerHTML = "";

    const _lat = Number(lat);
    const _lng = Number(lng);

    if (!Number.isFinite(_lat) || !Number.isFinite(_lng) || _lat === 0 || _lng === 0) {
      mapContainer.innerHTML = "ìœ„ì¹˜ ì •ë³´ ì—†ìŒ";
      return;
    }

    if (!kakaoReady || !window.kakao || !kakao.maps) {
      mapContainer.innerHTML = "ì¹´ì¹´ì˜¤ ì§€ë„ SDK ì¤€ë¹„ ì•ˆ ë¨ (ë„ë©”ì¸ ë“±ë¡/ë¡œì»¬ì„œë²„ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸)";
      return;
    }

    const map = new kakao.maps.Map(mapContainer, {
      center: new kakao.maps.LatLng(_lat, _lng),
      level: 3
    });

    // relayout í›„ center ì¬ì„¤ì •
    setTimeout(() => {
      map.relayout();
      map.setCenter(new kakao.maps.LatLng(_lat, _lng));
    }, 0);

    new kakao.maps.Marker({
      map,
      position: new kakao.maps.LatLng(_lat, _lng)
    });
  }

  function goBack() {
    document.getElementById("detailView").classList.add("hidden");
    document.getElementById("listView").classList.remove("hidden");
    document.getElementById("header").innerText = "ë¶€ì‚° ë§›ì§‘";
  }

  function loadReviews() {
    const list = document.getElementById("reviewList");
    const reviews = JSON.parse(localStorage.getItem("reviews_" + currentId)) || [];
    list.innerHTML = reviews.map(r => `<div class="review">${escapeHtml(r)}</div>`).join("");
  }

  function saveReview() {
    const input = document.getElementById("reviewInput");
    if (!input.value.trim()) return;

    const key = "reviews_" + currentId;
    const reviews = JSON.parse(localStorage.getItem(key)) || [];
    reviews.push(input.value);
    localStorage.setItem(key, JSON.stringify(reviews));

    input.value = "";
    loadReviews();
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
</script>
</body>
</html>
