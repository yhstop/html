<!--
  ë¶€ì‚°ê´‘ì—­ì‹œ_ë¶€ì‚° ë§›ì§‘ ì •ë³´ ì„œë¹„ìŠ¤ (ì‹œì•ˆ ê¸°ë°˜)
  - HTML/CSS/JS ONLY
  - Data: https://apis.data.go.kr/6260000/FoodService/getFoodKr
  - Map: Kakao Maps JS SDK

  ì‚¬ìš© ë°©ë²•
  1) ì´ íŒŒì¼ì„ index.html ë¡œ ì €ì¥
  2) ì•„ë˜ YOUR_* í‚¤ ê°’ì„ ë³¸ì¸ í‚¤ë¡œ êµì²´
     - YOUR_DATA_GO_KR_SERVICE_KEY: ê³µê³µë°ì´í„°í¬í„¸ ì¼ë°˜ ì¸ì¦í‚¤(Decoding ê¶Œì¥)
     - YOUR_KAKAO_JAVASCRIPT_KEY: ì¹´ì¹´ì˜¤ JavaScript í‚¤
  3) ë¡œì»¬ ì‹¤í–‰ì€ Live Server ë“± HTTP ì„œë²„ë¡œ ì‹¤í–‰ (file:// ì‹¤í–‰ X)
-->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶€ì‚° ë§›ì§‘ ì •ë³´</title>

  <!-- Kakao Maps SDK: ë³¸ì¸ appkeyë¡œ êµì²´ -->
  <!--
    Kakao Maps SDK
    - autoload=false ë¡œ ë‘ê³ , JSì—ì„œ kakao.maps.load()ë¡œ ì´ˆê¸°í™” íƒ€ì´ë°ì„ ì œì–´í•©ë‹ˆë‹¤.
    - (ì¤‘ìš”) defer ìƒíƒœì—ì„œ inline scriptê°€ ë¨¼ì € ì‹¤í–‰ë˜ë©´ kakao ê°ì²´ê°€ ì—†ì–´ ì§€ë„ê°€ ì•ˆ ëœ¨ëŠ” ë¬¸ì œê°€ ìì£¼ ë°œìƒí•©ë‹ˆë‹¤.
  -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=3ca8f8ca6e23307fccc79051a54d9f4a&autoload=false"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --chip:#f1f5f9;
      --shadow: 0 10px 30px rgba(15, 23, 42, .08);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Arial;
      color:var(--text);
      background:var(--bg);
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(246,247,251,.9);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }
    .topbar__inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .brand{
      margin:0;
      font-size:18px;
      letter-spacing:-.2px;
      white-space:nowrap;
    }
    .search{
      flex:1;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .search input{
      width:100%;
      height:40px;
      padding:0 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      outline:none;
    }
    .search input:focus{ border-color:#94a3b8; }
    .iconBtn{
      width:40px; height:40px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      cursor:pointer;
    }
    .filters{ display:flex; gap:8px; }
    select{
      height:40px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:0 12px;
      background:#fff;
    }

    .layout{
      max-width:1200px;
      margin:16px auto;
      padding:0 16px 20px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: calc(100vh - 140px);
    }
    .panel__head{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .panel__title{ font-weight:700; letter-spacing:-.2px; }
    .panel__meta{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:13px;
    }
    .pager{ display:flex; align-items:center; gap:8px; }
    .btn{
      height:34px;
      padding:0 10px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      cursor:pointer;
    }

    .list{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease;
      background:#fff;
    }
    .card:hover{ transform: translateY(-1px); border-color:#cbd5e1; }
    .card__title{ font-weight:800; letter-spacing:-.3px; margin:0 0 6px; }
    .card__sub{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }
    .card__chips{ margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
    .chip{
      background:var(--chip);
      border:1px solid var(--line);
      color:#334155;
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
    }

    .card__actions{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
    .heart{ border:none; background:transparent; font-size:20px; cursor:pointer; color:#0f172a; }
    .miniIcon{ width:34px; height:34px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }

    .detail{ display:grid; grid-template-rows: 320px 1fr; }
    .detail__media{ position:relative; background:#0b1220; }
    .detail__media img{ width:100%; height:100%; object-fit:cover; display:block; opacity:.95; }
    .fav{
      position:absolute;
      left:14px; top:14px;
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-size:22px;
      cursor:pointer;
    }
    .detail__body{ padding:14px; display:flex; flex-direction:column; gap:10px; }
    .kv{ display:grid; grid-template-columns: 90px 1fr; gap:10px; align-items:flex-start; }
    .kv__key{
      display:inline-flex;
      justify-content:center;
      align-items:center;
      height:28px;
      border-radius:8px;
      background:#0f172a;
      color:#fff;
      font-size:12px;
      font-weight:700;
    }
    .kv__val{ padding-top:2px; line-height:1.5; color:#0f172a; }

    .mapWrap{ margin-top:6px; border-top:1px solid var(--line); padding-top:10px; }
    .mapTitle{ font-weight:800; margin-bottom:8px; }
    .map{ width:100%; height:260px; border-radius:14px; border:1px solid var(--line); overflow:hidden; }

    .empty{ padding:18px; color:var(--muted); }
    .loading, .error{ padding:12px 14px; color:var(--muted); }
    .error{ color:#b91c1c; }
    .hidden{ display:none !important; }

    .footer{ padding:14px 0 22px; color:var(--muted); font-size:12px; text-align:center; }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .panel{ min-height:auto; }
      .detail{ grid-template-rows: 260px 1fr; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar__inner">
      <h1 class="brand">ë¶€ì‚° ë§›ì§‘</h1>

      <div class="search">
        <input id="searchInput" type="search" placeholder="ê°€ê²Œëª…/ë©”ë‰´/ì£¼ì†Œ ê²€ìƒ‰" />
        <button id="searchBtn" class="iconBtn" title="ê²€ìƒ‰">ğŸ”</button>
      </div>

      <div class="filters">
        <select id="gugunSelect">
          <option value="">ì „ì²´ êµ¬/êµ°</option>
        </select>

        <select id="rowsSelect">
          <option value="10" selected>10ê°œ</option>
          <option value="20">20ê°œ</option>
          <option value="50">50ê°œ</option>
        </select>
      </div>
    </div>
  </header>

  <main class="layout">
    <section class="panel listPanel">
      <div class="panel__head">
        <div class="panel__title">ë§›ì§‘ ëª©ë¡</div>
        <div class="panel__meta">
          <span id="countText">0ê°œ</span>
          <div class="pager">
            <button id="prevBtn" class="btn">ì´ì „</button>
            <span id="pageText">1</span>
            <button id="nextBtn" class="btn">ë‹¤ìŒ</button>
          </div>
        </div>
      </div>

      <div id="list" class="list"></div>

      <div id="listLoading" class="loading hidden">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      <div id="listError" class="error hidden"></div>
    </section>

    <section class="panel detailPanel">
      <div id="emptyDetail" class="empty">
        ì™¼ìª½ ëª©ë¡ì—ì„œ ë§›ì§‘ì„ ì„ íƒí•´ ì£¼ì„¸ìš” ğŸ™‚
      </div>

      <article id="detail" class="detail hidden">
        <div class="detail__media">
          <button id="favBtn" class="fav" title="ì°œ">â™¡</button>
          <img id="detailImg" alt="" />
        </div>

        <div class="detail__body">
          <div class="kv">
            <div class="kv__key">ìƒí˜¸ëª…</div>
            <div class="kv__val" id="dTitle">-</div>
          </div>

          <div class="kv">
            <div class="kv__key">ì£¼ì†Œ</div>
            <div class="kv__val" id="dAddr">-</div>
          </div>

          <div class="kv">
            <div class="kv__key">ì†Œê°œ</div>
            <div class="kv__val" id="dDesc">-</div>
          </div>

          <div class="kv">
            <div class="kv__key">ëŒ€í‘œë©”ë‰´</div>
            <div class="kv__val" id="dMenu">-</div>
          </div>

          <div class="kv">
            <div class="kv__key">ë¬¸ì˜</div>
            <div class="kv__val" id="dTel">-</div>
          </div>

          <div class="kv">
            <div class="kv__key">ìš´ì˜ì‹œê°„</div>
            <div class="kv__val" id="dTime">-</div>
          </div>

          <div class="mapWrap">
            <div class="mapTitle">ì§€ë„</div>
            <div id="map" class="map"></div>
          </div>
        </div>
      </article>
    </section>
  </main>

  <footer class="footer">
    <div class="footer__inner">ë°ì´í„° ì¶œì²˜: ê³µê³µë°ì´í„°í¬í„¸(ë¶€ì‚°ê´‘ì—­ì‹œ_ë¶€ì‚°ë§›ì§‘ì •ë³´)</div>
  </footer>

  <script>
    // -------------------- Config --------------------
    const API_BASE = "https://apis.data.go.kr/6260000/FoodService/getFoodKr";

    // âœ… (ì„ íƒ) CORSê°€ ë§‰í˜€ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í˜¸ì¶œì´ ì‹¤íŒ¨í•˜ë©´, í”„ë¡ì‹œë¥¼ í†µí•´ ìš°íšŒí•´ì•¼ í•©ë‹ˆë‹¤.
    // - ì•„ë˜ PROXY_PREFIXë¥¼ ë¹„ì›Œë‘ë©´("") ì§ì ‘ í˜¸ì¶œë§Œ ì‹œë„í•©ë‹ˆë‹¤.
    // - ì˜ˆ: corsproxy.io ëŠ” "https://corsproxy.io/?" ì²˜ëŸ¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (ì™¸ë¶€ ì„œë¹„ìŠ¤ë¼ í™˜ê²½ì— ë”°ë¼ ë§‰í ìˆ˜ ìˆìŒ)
    // - ê°€ì¥ ì•ˆì •ì ì¸ ë°©ë²•: ë³¸ì¸ ì„œë²„/ì„œë²„ë¦¬ìŠ¤(Worker ë“±)ë¡œ í”„ë¡ì‹œë¥¼ í•˜ë‚˜ ë‘ëŠ” ê²ƒ
    const PROXY_PREFIX = ""; // ì˜ˆ: "https://corsproxy.io/?"

    // âœ… ê°œë°œ/ë””ìì¸ í™•ì¸ìš©: API í˜¸ì¶œì´ ì‹¤íŒ¨í•˜ë©´ ìƒ˜í”Œ ë°ì´í„°ë¡œ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
    let FORCE_SAMPLE_MODE = false;

    // âœ… ì—¬ê¸°ì— ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤(serviceKey)ë¥¼ ë„£ìœ¼ì„¸ìš”.
// - ê¶Œì¥: Decoding(ì¼ë°˜) í‚¤ë¥¼ ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ URL ì¸ì½”ë”©í•´ì„œ í˜¸ì¶œí•©ë‹ˆë‹¤.
// - ë§Œì•½ Encoding(ì´ë¯¸ %ë¡œ ì¸ì½”ë”©ëœ) í‚¤ë¥¼ ë„£ëŠ”ë‹¤ë©´, "%"ê°€ í¬í•¨ëœ í‚¤ëŠ” ì¶”ê°€ ì¸ì½”ë”© ì—†ì´ ê·¸ëŒ€ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
const SERVICE_KEY = "U3rjn1OQzoe833jk5RJokTl1sVFUmIQp7dGTZl0tcvNU7p2blLzjccSSgrAHQgyLYlBIm7Qt0wOFwQRvvG7h8Q==";

    let state = {
      pageNo: 1,
      numOfRows: 10,
      keyword: "",
      gugun: "",
      items: [],
      totalCount: 0,
      selected: null
    };

    let kakaoMap = null;
    let kakaoMarker = null;

    const $ = (sel) => document.querySelector(sel);

    const elList = $("#list");
    const elCount = $("#countText");
    const elPage = $("#pageText");
    const elLoading = $("#listLoading");
    const elError = $("#listError");

    const elEmptyDetail = $("#emptyDetail");
    const elDetail = $("#detail");

    const elSearchInput = $("#searchInput");
    const elSearchBtn = $("#searchBtn");
    const elGugun = $("#gugunSelect");
    const elRows = $("#rowsSelect");
    const elPrev = $("#prevBtn");
    const elNext = $("#nextBtn");

    const elFav = $("#favBtn");
    const elImg = $("#detailImg");
    const elDTitle = $("#dTitle");
    const elDAddr = $("#dAddr");
    const elDDesc = $("#dDesc");
    const elDMenu = $("#dMenu");
    const elDTel = $("#dTel");
    const elDTime = $("#dTime");
    // âœ… ì¹´ì¹´ì˜¤ SDK ë¡œë“œ íƒ€ì´ë° ë¬¸ì œë¥¼ í”¼í•˜ë ¤ê³ , DOM ì¤€ë¹„ + kakao.maps.load() ì™„ë£Œ í›„ì—ë§Œ initì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
    bootstrap();

    async function bootstrap() {
      if (document.readyState === "loading") {
        await new Promise((r) => document.addEventListener("DOMContentLoaded", r, { once: true }));
      }

      try {
        await ensureKakaoReady();
      } catch (e) {
        // SDK ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ ëª©ë¡ì€ ë™ì‘í•˜ë„ë¡ ë‘ 
        console.warn("Kakao Maps SDK not ready:", e);
      }

      init();
    }

    function init() {
      elRows.value = String(state.numOfRows);

      elSearchBtn.addEventListener("click", () => {
        state.keyword = (elSearchInput.value || "").trim();
        state.pageNo = 1;
        renderList();
      });

      elSearchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") elSearchBtn.click();
      });

      elRows.addEventListener("change", () => {
        state.numOfRows = Number(elRows.value);
        state.pageNo = 1;
        renderList();
      });

      elGugun.addEventListener("change", () => {
        state.gugun = elGugun.value;
        state.pageNo = 1;
        renderList();
      });

      elPrev.addEventListener("click", () => {
        if (state.pageNo > 1) {
          state.pageNo -= 1;
          renderList();
        }
      });

      elNext.addEventListener("click", () => {
        const lastPage = state.totalCount
          ? Math.ceil(state.totalCount / state.numOfRows)
          : state.pageNo + 1;

        if (state.pageNo < lastPage) {
          state.pageNo += 1;
          renderList();
        }
      });

      elFav.addEventListener("click", async () => {
        if (!state.selected) return;
        toggleFavorite(state.selected.UC_SEQ);
        await renderDetail(state.selected);
      });

      renderList();
    }

    // -------------------- Render List --------------------
    async function renderList() {
      setListStatus({ loading: true, error: "" });

      try {
        const data = await fetchFoodList(state.pageNo, state.numOfRows);
        const rawItems = normalizeItems(data);
        state.totalCount = Number(data?.getFoodKr?.totalCount || data?.totalCount || 0);

        fillGugunOptionsOnce(rawItems);

        const filtered = rawItems.filter((it) => {
          const matchesGugun = state.gugun ? (it.GUGUN_NM === state.gugun) : true;
          const matchesKeyword = state.keyword
            ? textBlob(it).includes(state.keyword.toLowerCase())
            : true;
          return matchesGugun && matchesKeyword;
        });

        state.items = filtered;
        elCount.textContent = `${filtered.length}ê°œ`;
        elPage.textContent = `${state.pageNo}`;

        elList.innerHTML = filtered.map(cardTemplate).join("");

        // ì¹´ë“œ í´ë¦­ -> ìƒì„¸
        elList.querySelectorAll("[data-ucseq]").forEach((card) => {
          card.addEventListener("click", async (e) => {
            const target = e.target;
            if (target.closest("button")) return;

            const ucSeq = card.getAttribute("data-ucseq");
            await openDetail(ucSeq);
          });
        });

        // ì°œ ë²„íŠ¼
        elList.querySelectorAll("[data-fav]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const ucSeq = btn.getAttribute("data-fav");
            toggleFavorite(ucSeq);
            btn.textContent = isFavorite(ucSeq) ? "â™¥" : "â™¡";
          });
        });

        // ì§€ë„ ë²„íŠ¼(ìƒì„¸ ì—´ê¸°)
        elList.querySelectorAll("[data-map]").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const ucSeq = btn.getAttribute("data-map");
            await openDetail(ucSeq);
            $("#detail").scrollIntoView({ behavior: "smooth", block: "start" });
          });
        });

        setListStatus({ loading: false, error: "" });

        // ì—ëŸ¬ ì˜ì—­ ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” 1íšŒë§Œ ê±¸ì–´ë‘¡ë‹ˆë‹¤.
        bindErrorActionsOnce();
      } catch (err) {
        console.error(err);
        setListStatus({ loading: false, error: formatErr(err) + extraHelpForAuth(err) + extraHelpForCors(err) });

        // ì—ëŸ¬ ì˜ì—­ ë²„íŠ¼(ìƒ˜í”Œ ëª¨ë“œ) ì´ë²¤íŠ¸ëŠ” 1íšŒë§Œ ê±¸ì–´ë‘¡ë‹ˆë‹¤.
        bindErrorActionsOnce();
      }
    }

    // -------------------- Detail --------------------
    async function openDetail(ucSeq) {
      try {
        const data = await fetchFoodDetail(ucSeq);
        const item = normalizeItems(data)[0] || state.items.find((x) => String(x.UC_SEQ) === String(ucSeq));

        if (!item) throw new Error("ìƒì„¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        state.selected = item;
        await renderDetail(item);
      } catch (err) {
        console.error(err);
        alert("ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨: " + formatErr(err));
      }
    }

    async function renderDetail(item) {
      elEmptyDetail.classList.add("hidden");
      elDetail.classList.remove("hidden");

      const imgUrl =
        item.MAIN_IMG_NORMAL ||
        item.MAIN_IMG_THUMB ||
        item.IMG_URL ||
        item.MAIN_IMG ||
        "";

      elImg.src = imgUrl || placeholderImage();
      elImg.alt = item.MAIN_TITLE || item.TITLE || "ë§›ì§‘ ì´ë¯¸ì§€";

      elDTitle.textContent = item.MAIN_TITLE || "-";
      elDAddr.textContent = item.ADDR1 || item.ADDR || "-";
      elDDesc.textContent = (item.ITEMCNTNTS || item.SUBTITLE || item.TITLE || "-").trim();
      elDMenu.textContent = item.RPRSNTV_MENU || item.MENU || "-";
      elDTel.textContent = item.CNTCT_TEL || item.TEL || "-";
      elDTime.textContent = item.USAGE_DAY_WEEK_AND_TIME || item.USAGE_TIME || "-";

      elFav.textContent = isFavorite(item.UC_SEQ) ? "â™¥" : "â™¡";

      const lat = Number(item.LAT);
      const lng = Number(item.LNG);
            if (Number.isFinite(lat) && Number.isFinite(lng)) {
        await renderKakaoMap(lat, lng, item.MAIN_TITLE || "ì„ íƒí•œ ìœ„ì¹˜");
      } else {
        $("#map").innerHTML = `<div style="padding:12px;color:#64748b;">ì¢Œí‘œ ì •ë³´(LAT/LNG)ê°€ ì—†ì–´ ì§€ë„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ì–´ìš”.</div>`;
      }
    }

    // -------------------- API --------------------
    async function fetchFoodList(pageNo, numOfRows) {
      if (FORCE_SAMPLE_MODE) {
        return sampleResponse(pageNo, numOfRows);
      }

      const directUrl = buildUrl({
        serviceKey: SERVICE_KEY,
        pageNo,
        numOfRows,
        resultType: "json"
      });

      const url = PROXY_PREFIX ? (PROXY_PREFIX + directUrl) : directUrl;

      const res = await fetch(url);
      if (!res.ok) {
        const body = await safeReadText(res);
        const err = new Error(`HTTP ${res.status}`);
        err.status = res.status;
        err.url = directUrl; // ì›ë³¸ URL(ë§ˆìŠ¤í‚¹í•´ì„œ ë³´ì—¬ì¤Œ)
        err.body = body;
        throw err;
      }

      // ì¼ë¶€ í”„ë¡ì‹œëŠ” content-typeì´ ì´ìƒí•  ìˆ˜ ìˆì–´ text->json fallback
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch {
        // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë¬¸ì„ ì—ëŸ¬ë¡œ ë³´ì—¬ì£¼ê¸°
        const err = new Error("ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨");
        err.status = 0;
        err.url = directUrl;
        err.body = text;
        throw err;
      }
    }

    async function fetchFoodDetail(ucSeq) {
      if (FORCE_SAMPLE_MODE) {
        const found = SAMPLE_ITEMS.find((x) => String(x.UC_SEQ) === String(ucSeq));
        return { getFoodKr: { item: found ? [found] : [] } };
      }

      const directUrl = buildUrl({
        serviceKey: SERVICE_KEY,
        pageNo: 1,
        numOfRows: 1,
        resultType: "json",
        UC_SEQ: ucSeq
      });

      const url = PROXY_PREFIX ? (PROXY_PREFIX + directUrl) : directUrl;

      const res = await fetch(url);
      if (!res.ok) {
        const body = await safeReadText(res);
        const err = new Error(`HTTP ${res.status}`);
        err.status = res.status;
        err.url = directUrl;
        err.body = body;
        throw err;
      }

      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch {
        const err = new Error("ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨");
        err.status = 0;
        err.url = directUrl;
        err.body = text;
        throw err;
      }
    }

    function buildUrl(params) {
      // âš ï¸ 401(Unauthorized) ê°€ì¥ í”í•œ ì›ì¸: serviceKey ì¸ì½”ë”© ë¬¸ì œ
      // - Encoding í‚¤(ì´ë¯¸ %ë¡œ ì¸ì½”ë”©ëœ í‚¤)ë¥¼ URLSearchParamsë¡œ ë‹¤ì‹œ ì¸ì½”ë”©í•˜ë©´ "ì´ì¤‘ ì¸ì½”ë”©"ì´ ë˜ì–´ 401ì´ ë‚  ìˆ˜ ìˆì–´ìš”.
      // - ê·¸ë˜ì„œ serviceKeyëŠ” "ì´ë¯¸ ì¸ì½”ë”©ëœ í‚¤ì¸ì§€" ê²€ì‚¬ í›„, í•„ìš”í•  ë•Œë§Œ encodeURIComponentë¥¼ ì ìš©í•©ë‹ˆë‹¤.
      const { serviceKey, ...rest } = params;

      const usp = new URLSearchParams();
      Object.entries(rest).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== "") usp.append(k, String(v));
      });

      const sk = normalizeServiceKey(serviceKey);
      const qs = usp.toString();
      return `${API_BASE}?serviceKey=${sk}${qs ? `&${qs}` : ""}`;
    }

    function normalizeServiceKey(key) {
      if (!key) return "";
      // ì´ë¯¸ %HH í˜•íƒœê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´(Encoding í‚¤) ì¶”ê°€ ì¸ì½”ë”© ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      if (/%[0-9A-Fa-f]{2}/.test(key)) return key;
      // ê·¸ ì™¸(Decoding í‚¤)ëŠ” ì•ˆì „í•˜ê²Œ ì¸ì½”ë”©
      return encodeURIComponent(key);
    }

    function normalizeItems(data) {
      const root = data?.getFoodKr || data?.response?.body || data;
      const items =
        root?.item ||
        root?.items ||
        root?.body?.items ||
        root?.body?.item ||
        [];

      if (Array.isArray(items)) return items;
      if (items && typeof items === "object") return [items];
      return [];
    }

    // -------------------- UI Helpers --------------------
    function cardTemplate(it) {
      const title = it.MAIN_TITLE || "ì´ë¦„ ì—†ìŒ";
      const addr = it.ADDR1 || "-";
      const menu = it.RPRSNTV_MENU || it.MENU || "-";
      const gugun = it.GUGUN_NM || "êµ¬/êµ°";
      const ucSeq = it.UC_SEQ;

      return `
        <div class="card" data-ucseq="${escapeHtml(String(ucSeq))}">
          <div>
            <div class="card__title">${escapeHtml(title)}</div>
            <p class="card__sub">ì£¼ì†Œ: ${escapeHtml(addr)}</p>
            <p class="card__sub">ë©”ë‰´: ${escapeHtml(menu)}</p>
            <div class="card__chips">
              <span class="chip">${escapeHtml(gugun)}</span>
            </div>
          </div>

          <div class="card__actions">
            <button class="heart" data-fav="${escapeHtml(String(ucSeq))}" title="ì°œ">
              ${isFavorite(ucSeq) ? "â™¥" : "â™¡"}
            </button>
            <button class="miniIcon" data-map="${escapeHtml(String(ucSeq))}" title="ì§€ë„ ë³´ê¸°">ğŸ“</button>
          </div>
        </div>
      `;
    }

    function setListStatus({ loading, error }) {
      elLoading.classList.toggle("hidden", !loading);
      elError.classList.toggle("hidden", !error);

      // textContent ëŒ€ì‹  HTMLì„ ì¨ì„œ ë²„íŠ¼/ë§í¬ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
      // (ë³´ì•ˆ) ì—ëŸ¬ ë©”ì‹œì§€ëŠ” ìš°ë¦¬ê°€ ë§Œë“  ë¬¸ìì—´ë§Œ ë„£ìŠµë‹ˆë‹¤.
      elError.innerHTML = error ? `<pre style="margin:0;white-space:pre-wrap;font-family:inherit;">${escapeHtml(error)}</pre>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
  <button id="useSampleBtn" class="btn" type="button">ìƒ˜í”Œ ë°ì´í„°ë¡œ í™”ë©´ ë³´ê¸°</button>
  <button id="retryBtn" class="btn" type="button">ë‹¤ì‹œ ì‹œë„</button>
</div>` : "";
    }

    function textBlob(it) {
      return [
        it.MAIN_TITLE,
        it.ADDR1,
        it.RPRSNTV_MENU,
        it.TITLE,
        it.SUBTITLE,
        it.GUGUN_NM
      ]
        .filter(Boolean)
        .join(" ")
        .toLowerCase();
    }

    function fillGugunOptionsOnce(items) {
      if (elGugun.options.length > 1) return;

      const set = new Set(items.map((x) => x.GUGUN_NM).filter(Boolean));
      [...set].sort().forEach((g) => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        elGugun.appendChild(opt);
      });
    }

    // -------------------- Favorites (localStorage) --------------------
    const FAV_KEY = "busan_food_favs_v1";

    function getFavSet() {
      try {
        const raw = localStorage.getItem(FAV_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(arr.map(String));
      } catch {
        return new Set();
      }
    }

    function saveFavSet(set) {
      localStorage.setItem(FAV_KEY, JSON.stringify([...set]));
    }

    function isFavorite(ucSeq) {
      const set = getFavSet();
      return set.has(String(ucSeq));
    }

    function toggleFavorite(ucSeq) {
      const set = getFavSet();
      const key = String(ucSeq);
      if (set.has(key)) set.delete(key);
      else set.add(key);
      saveFavSet(set);
    }

    // -------------------- Kakao Map --------------------
    async function renderKakaoMap(lat, lng, title) {
      const container = $("#map");

      // 1) SDK ë¡œë“œ/ì´ˆê¸°í™” ë³´ì¥
      try {
        await ensureKakaoReady();
      } catch {
        container.innerHTML = `<div style="padding:12px;color:#64748b;">ì¹´ì¹´ì˜¤ë§µ SDKê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.<br/>- appkeyê°€ ì˜¬ë°”ë¥¸ì§€<br/>- ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†”ì—ì„œ <b>í”Œë«í¼(Web) ë„ë©”ì¸</b> ë“±ë¡ì´ ë˜ì—ˆëŠ”ì§€<br/>í™•ì¸í•´ ì£¼ì„¸ìš”.</div>`;
        return;
      }

      // 2) ìƒì„¸ íŒ¨ë„ì´ ë§‰ ì—´ë¦¬ëŠ” ìˆœê°„ì—ëŠ” map div í¬ê¸° ê³„ì‚°ì´ 0ì¼ ìˆ˜ ìˆì–´ relayoutì´ í•„ìš”í•©ë‹ˆë‹¤.
      await new Promise((r) => requestAnimationFrame(r));

      const pos = new kakao.maps.LatLng(lat, lng);

      if (!kakaoMap) {
        kakaoMap = new kakao.maps.Map(container, { center: pos, level: 3 });
        kakaoMarker = new kakao.maps.Marker({ position: pos });
        kakaoMarker.setMap(kakaoMap);
      } else {
        kakaoMap.relayout();
        kakaoMap.setCenter(pos);
        kakaoMarker.setPosition(pos);
      }

      const iwContent = `<div style="padding:6px 8px;font-size:12px;">${escapeHtml(title)}</div>`;
      const iw = new kakao.maps.InfoWindow({ content: iwContent });
      iw.open(kakaoMap, kakaoMarker);
    }

    function ensureKakaoReady() {
      // autoload=false ì¸ ê²½ìš° kakao.maps.load()ë¡œ ë¡œë”© ì™„ë£Œ ì½œë°±ì„ ë°›ìŠµë‹ˆë‹¤.
      return new Promise((resolve, reject) => {
        if (window.kakao && window.kakao.maps) {
          try {
            window.kakao.maps.load(() => resolve());
          } catch {
            resolve();
          }
          return;
        }

        const started = Date.now();
        const timer = setInterval(() => {
          if (window.kakao && window.kakao.maps) {
            clearInterval(timer);
            try {
              window.kakao.maps.load(() => resolve());
            } catch {
              resolve();
            }
          } else if (Date.now() - started > 5000) {
            clearInterval(timer);
            reject(new Error("Kakao SDK load timeout"));
          }
        }, 50);
      });
    }

    // -------------------- Utils --------------------
    function placeholderImage() {
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
          <rect width="100%" height="100%" fill="#0b1220"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            fill="#94a3b8" font-size="36" font-family="Arial">
            ì´ë¯¸ì§€ ì—†ìŒ
          </text>
        </svg>
      `);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    function escapeHtml(str) {
      return str
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatErr(err) {
      if (typeof err === "string") return err;
      if (!err) return "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";

      const status = err.status ? ` (status: ${err.status})` : "";
      let msg = err.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
      msg += status;

      // ë””ë²„ê·¸ìš©: URLì€ serviceKey ë§ˆìŠ¤í‚¹í•´ì„œ ë…¸ì¶œ
      if (err.url) {
        msg += `
ìš”ì²­ URL: ${maskServiceKey(err.url)}`;
      }
      return msg;
    }

    function extraHelpForAuth(err) {
      // âœ… ë¬¸ìì—´ ë¦¬í„°ëŸ´ì— 'ê·¸ëƒ¥ ì¤„ë°”ê¿ˆ'ì´ ë“¤ì–´ê°€ë©´ SyntaxError(Invalid or unexpected token)ê°€ ë‚©ë‹ˆë‹¤.
      // ê·¸ë˜ì„œ í…œí”Œë¦¿ ë¦¬í„°ëŸ´(``)ë¡œ ì•ˆì „í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.
      if (err && Number(err.status) === 401) {
        return `

[í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸]
1) serviceKeyê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸ (ê³µê³µë°ì´í„°í¬í„¸ > ë§ˆì´í˜ì´ì§€ > ì¸ì¦í‚¤)
2) Encoding í‚¤(%ë¡œ ì‹œì‘/í¬í•¨ëœ í‚¤)ë¥¼ ë„£ì—ˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤(ì´ì¤‘ ì¸ì½”ë”© ê¸ˆì§€)
3) Decoding í‚¤ë¥¼ ë„£ì—ˆë‹¤ë©´ ì§€ê¸ˆ ì½”ë“œê°€ ìë™ ì¸ì½”ë”©í•©ë‹ˆë‹¤
4) í‚¤ ì•ë’¤ ê³µë°±/ì¤„ë°”ê¿ˆì´ ë“¤ì–´ê°€ë©´ 401ì´ ë‚  ìˆ˜ ìˆì–´ìš”

â€» ì—¬ì „íˆ 401ì´ë©´, ê³µê³µë°ì´í„°í¬í„¸ì—ì„œ í•´ë‹¹ APIì˜ 'í™œìš©ì‹ ì²­/ìŠ¹ì¸ ìƒíƒœ'ë„ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
      }
      return "";
    }

    function extraHelpForCors(err) {
      // ë¸Œë¼ìš°ì € fetchì—ì„œ CORSë¡œ ë§‰íˆë©´ ë³´í†µ status ì—†ì´ TypeError: Failed to fetch í˜•íƒœê°€ ë‚©ë‹ˆë‹¤.
      const isFailedFetch = err && err.name === "TypeError" && /fetch/i.test(err.message || "");
      const isNoStatus = err && (err.status === undefined || err.status === null);

      if (isFailedFetch || isNoStatus) {
        return `

[ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•˜ëŠ” ê²½ìš°(CORS ê°€ëŠ¥ì„±)]
- ê³µê³µë°ì´í„° OpenAPIê°€ ë¸Œë¼ìš°ì € ì§ì ‘ í˜¸ì¶œì„ í—ˆìš©í•˜ì§€ ì•Šìœ¼ë©´(CORS ì°¨ë‹¨) í™”ë©´ì— í‘œì‹œê°€ ì•ˆ ë©ë‹ˆë‹¤.
- í•´ê²°: í”„ë¡ì‹œë¥¼ í†µí•´ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
  1) ê°€ì¥ ì•ˆì •ì : ë³¸ì¸ ì„œë²„/ì„œë²„ë¦¬ìŠ¤(Worker ë“±)ì— í”„ë¡ì‹œ 1ê°œ ë§Œë“¤ê¸°
  2) ì„ì‹œ: PROXY_PREFIXì— í”„ë¡ì‹œ ì£¼ì†Œë¥¼ ë„£ê¸°(ì˜ˆ: https://corsproxy.io/?)

â€» ì•„ë˜ 'ìƒ˜í”Œ ë°ì´í„°ë¡œ í™”ë©´ ë³´ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ UIëŠ” ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.`;
      }
      return "";
    }

    function maskServiceKey(url) {
      try {
        const u = new URL(url);
        const sk = u.searchParams.get("serviceKey");
        if (!sk) return url;
        const tail = sk.slice(-4);
        u.searchParams.set("serviceKey", `****${tail}`);
        return u.toString();
      } catch {
        return url;
      }
    }

    async function safeReadText(res) {
      try {
        return await res.text();
      } catch {
        return "";
      }
    }

    // -------------------- Error Actions --------------------
    let errorActionsBound = false;
    function bindErrorActionsOnce() {
      if (errorActionsBound) return;
      errorActionsBound = true;

      elError.addEventListener("click", (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;

        if (t.id === "useSampleBtn") {
          FORCE_SAMPLE_MODE = true;
          state.pageNo = 1;
          renderList();
        }

        if (t.id === "retryBtn") {
          renderList();
        }
      });
    }

    // -------------------- Sample Data (UI í™•ì¸ìš©) --------------------
    const SAMPLE_ITEMS = [
      {
        UC_SEQ: 1,
        MAIN_TITLE: "ë§Œë“œë¦¬ê³¤ë“œë ˆë°¥",
        GUGUN_NM: "ê°•ì„œêµ¬",
        ADDR1: "ë¶€ì‚° ê°•ì„œêµ¬ ê³µí•­ì•ê¸¸ 85ë²ˆê¸¸ 13",
        RPRSNTV_MENU: "ëŒì†¥ê³¤ë“œë ˆì •ì‹, ë‹¨í˜¸ë°•ì˜¤ë¦¬í›ˆì œ",
        ITEMCNTNTS: "ìƒ ê³¤ë“œë ˆë‚˜ë¬¼ì„ ì‚¬ìš©í•œ ëŒì†¥ë°¥ê³¼ ë‹¤ì–‘í•œ ë°˜ì°¬ì´ ì¸ê¸°ì…ë‹ˆë‹¤.",
        CNTCT_TEL: "051-941-3669",
        USAGE_DAY_WEEK_AND_TIME: "11:00-21:00 (20:00 ë¼ìŠ¤íŠ¸ì˜¤ë”)",
        MAIN_IMG_NORMAL: "",
        LAT: 35.1765,
        LNG: 128.9477
      },
      {
        UC_SEQ: 2,
        MAIN_TITLE: "ê°€ì•¼í• ë§¤ë°€ë©´",
        GUGUN_NM: "ë¶€ì‚°ì§„êµ¬",
        ADDR1: "ë¶€ì‚° ë¶€ì‚°ì§„êµ¬ ì›”ë“œì»µëŒ€ë¡œ 145ë²ˆê¸¸ 32",
        RPRSNTV_MENU: "ë¬¼ë°€ë©´, ë¹„ë¹”ë°€ë©´",
        ITEMCNTNTS: "ë¶€ì‚° ëŒ€í‘œ ë°€ë©´ ë§›ì§‘ìœ¼ë¡œ ì•Œë ¤ì ¸ ìˆìŠµë‹ˆë‹¤.",
        CNTCT_TEL: "-",
        USAGE_DAY_WEEK_AND_TIME: "-",
        MAIN_IMG_NORMAL: "",
        LAT: 35.1598,
        LNG: 129.0564
      },
      {
        UC_SEQ: 3,
        MAIN_TITLE: "ê±°ì¸í†µë‹­",
        GUGUN_NM: "ì¤‘êµ¬",
        ADDR1: "ë¶€ì‚° ì¤‘êµ¬ ì¤‘êµ¬ë¡œ47ë²ˆê¸¸ 34",
        RPRSNTV_MENU: "í›„ë¼ì´ë“œì¹˜í‚¨",
        ITEMCNTNTS: "ì „í†µì‹œì¥ ê°ì„±ì˜ í†µë‹­ ë§›ì§‘ìœ¼ë¡œ ìœ ëª…í•©ë‹ˆë‹¤.",
        CNTCT_TEL: "-",
        USAGE_DAY_WEEK_AND_TIME: "-",
        MAIN_IMG_NORMAL: "",
        LAT: 35.1065,
        LNG: 129.0322
      }
    ];

    function sampleResponse(pageNo, numOfRows) {
      // í˜ì´ì§€ í‰ë‚´
      const start = (pageNo - 1) * numOfRows;
      const slice = SAMPLE_ITEMS.slice(start, start + numOfRows);
      return {
        getFoodKr: {
          totalCount: SAMPLE_ITEMS.length,
          item: slice
        }
      };
    }
  </script>
</body>
</html>
