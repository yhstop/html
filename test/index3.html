<!--
  ë¶€ì‚°ê´‘ì—­ì‹œ_ë¶€ì‚° ë§›ì§‘ ì •ë³´ ì„œë¹„ìŠ¤ (ëª¨ë°”ì¼ ì „ìš©)
  - HTML/CSS/JS ONLY (ë‹¨ì¼ íŒŒì¼)
  - Data: https://apis.data.go.kr/6260000/FoodService/getFoodKr
  - Map: Kakao Maps JS SDK

  ì‚¬ìš© ë°©ë²•
  1) ì´ íŒŒì¼ì„ index.html ë¡œ ì €ì¥
  2) ì•„ë˜ YOUR_* í‚¤ ê°’ì„ ë³¸ì¸ í‚¤ë¡œ êµì²´
     - YOUR_DATA_GO_KR_SERVICE_KEY: ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤(serviceKey)
     - YOUR_KAKAO_JAVASCRIPT_KEY: ì¹´ì¹´ì˜¤ JavaScript í‚¤
  3) ë¡œì»¬ ì‹¤í–‰ì€ Live Server ë“± HTTP ì„œë²„ë¡œ ì‹¤í–‰ (file:// ì‹¤í–‰ X)
  4) ì¹´ì¹´ì˜¤ ì§€ë„ ì•ˆ ëœ¨ë©´: ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†”ì—ì„œ í”Œë«í¼(Web) ë„ë©”ì¸ ë“±ë¡ í•„ìˆ˜
-->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ë¶€ì‚° ë§›ì§‘ ì •ë³´ (Mobile)</title>

  <!-- Kakao Maps SDK (autoload=false) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_JAVASCRIPT_KEY&autoload=false"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#111c33;
      --card2:#0d1730;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line: rgba(148,163,184,.18);
      --chip: rgba(148,163,184,.12);
      --brand:#38bdf8;
      --danger:#fb7185;
      --radius: 16px;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(56,189,248,.18), transparent 55%),
                  radial-gradient(900px 500px at 110% 20%, rgba(167,139,250,.16), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Arial;
      -webkit-font-smoothing: antialiased;
      overflow:hidden; /* ëª¨ë°”ì¼ ì•± ëŠë‚Œ */
    }

    /* App Shell */
    .app{
      height:100vh;
      height:100dvh;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      padding: calc(10px + var(--safe-top)) 14px 10px;
      border-bottom:1px solid var(--line);
      background: rgba(11,18,32,.78);
      backdrop-filter: blur(14px);
    }

    .toprow{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .backBtn{
      width:40px;height:40px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
    }

    .brand{
      margin:0;
      font-size:16px;
      letter-spacing:-.2px;
      line-height:1;
    }

    .sub{
      margin:0;
      font-size:12px;
      color:var(--muted);
      letter-spacing:-.1px;
    }

    .searchRow{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .searchRow input{
      flex:1;
      height:42px;
      border-radius:999px;
      border:1px solid var(--line);
      padding:0 14px;
      outline:none;
      background: rgba(255,255,255,.06);
      color:var(--text);
    }

    .iconBtn{
      width:42px;height:42px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
    }

    .filterRow{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
    }

    select{
      height:40px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:0 12px;
      outline:none;
    }

    /* Views */
    .views{
      flex:1;
      position:relative;
      overflow:hidden;
    }

    .view{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      transform: translateX(100%);
      opacity:0;
      pointer-events:none;
      transition: transform .22s ease, opacity .18s ease;
    }

    .view.is-active{
      transform: translateX(0);
      opacity:1;
      pointer-events:auto;
    }

    .view.is-exit-left{
      transform: translateX(-20%);
      opacity:0;
    }

    /* List */
    .scroll{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px 14px calc(90px + var(--safe-bot));
    }

    .metaBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 2px 10px;
      color:var(--muted);
      font-size:12px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      cursor:pointer;
    }

    .card__title{ margin:0 0 6px; font-weight:800; letter-spacing:-.3px; font-size:15px; }
    .card__sub{ margin:0; color:var(--muted); font-size:12px; line-height:1.35; }

    .chips{ margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
    .chip{ background: var(--chip); border:1px solid var(--line); padding:4px 8px; border-radius:999px; font-size:11px; color: var(--text); }

    .actions{ display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
    .heart{ border:none; background:transparent; font-size:20px; cursor:pointer; color:var(--text); }
    .mini{ width:36px; height:36px; border-radius:14px; border:1px solid var(--line); background: rgba(255,255,255,.06); color:var(--text); cursor:pointer; }

    .bottomBar{
      position:sticky;
      bottom:0;
      z-index:15;
      padding: 10px 14px calc(10px + var(--safe-bot));
      border-top:1px solid var(--line);
      background: rgba(11,18,32,.78);
      backdrop-filter: blur(14px);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }

    .btn{
      height:40px;
      padding:0 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{ border-color: rgba(56,189,248,.35); box-shadow: 0 0 0 3px rgba(56,189,248,.12) inset; }

    .loading, .error{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding:12px;
    }
    .error{ color: #fecaca; border-color: rgba(251,113,133,.35); }

    /* Detail */
    .hero{
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }

    .heroImg{
      width:100%;
      height: 240px;
      object-fit:cover;
      display:block;
      background:#020617;
    }

    .heroOverlay{
      position:relative;
      margin-top:-56px;
      padding: 0 14px;
    }

    .detailCard{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .detailTitleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .dTitle{ margin:0; font-size:18px; font-weight:900; letter-spacing:-.4px; }
    .favBtn{
      width:44px;height:44px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-size:20px;
    }

    .kv{
      display:grid;
      grid-template-columns: 86px 1fr;
      gap:10px;
      padding: 10px 0;
      border-top:1px dashed rgba(148,163,184,.18);
    }
    .kv:first-of-type{ border-top:none; padding-top:12px; }
    .k{ color:var(--muted); font-size:12px; }
    .v{ color:var(--text); font-size:13px; line-height:1.5; }

    .mapWrap{ margin-top:12px; }
    .mapTitle{ font-weight:900; font-size:14px; margin: 0 0 8px; }
    .map{ width:100%; height: 260px; border-radius: 18px; border:1px solid var(--line); overflow:hidden; background: rgba(255,255,255,.04); }

    .toast{
      position:fixed;
      left:50%;
      bottom: calc(70px + var(--safe-bot));
      transform: translateX(-50%);
      background: rgba(2,6,23,.82);
      border:1px solid var(--line);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:50;
    }
    .toast.show{ opacity:1; }

    /* Desktopì—ì„œ ëª¨ë°”ì¼ì²˜ëŸ¼ ë³´ì´ê²Œ */
    @media (min-width: 768px){
      body{ display:flex; justify-content:center; }
      .app{
        max-width: 430px;
        width: 430px;
        border-left: 1px solid rgba(148,163,184,.12);
        border-right: 1px solid rgba(148,163,184,.12);
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Topbar: list / detail ê³µìš©. detailì—ì„œ back ë²„íŠ¼ í‘œì‹œ -->
    <header class="topbar">
      <div class="toprow">
        <button id="backBtn" class="backBtn" type="button" aria-label="ë’¤ë¡œ" style="display:none;">â†</button>
        <div>
          <h1 class="brand" id="topTitle">ë¶€ì‚° ë§›ì§‘</h1>
          <p class="sub" id="topSub">ë¶€ì‚°ê´‘ì—­ì‹œ_ë¶€ì‚° ë§›ì§‘ ì •ë³´</p>
        </div>
      </div>

      <!-- ë¦¬ìŠ¤íŠ¸ í™”ë©´ì—ì„œë§Œ ë…¸ì¶œ -->
      <div id="listControls">
        <div class="searchRow">
          <input id="searchInput" type="search" placeholder="ê°€ê²Œëª…/ë©”ë‰´/ì£¼ì†Œ ê²€ìƒ‰" />
          <button id="searchBtn" class="iconBtn" type="button" title="ê²€ìƒ‰">ğŸ”</button>
        </div>
        <div class="filterRow">
          <select id="gugunSelect">
            <option value="">ì „ì²´ êµ¬/êµ°</option>
          </select>
          <select id="rowsSelect">
            <option value="10" selected>10ê°œ</option>
            <option value="20">20ê°œ</option>
            <option value="50">50ê°œ</option>
          </select>
          <button id="toggleFavOnly" class="btn" type="button" title="ì°œë§Œ ë³´ê¸°">â™¥</button>
        </div>
      </div>
    </header>

    <main class="views">
      <!-- LIST VIEW -->
      <section id="viewList" class="view is-active" aria-label="ëª©ë¡">
        <div class="scroll">
          <div class="metaBar">
            <div class="pill">í‘œì‹œ <b id="countText">0</b>ê°œ</div>
            <div class="pill">í˜ì´ì§€ <b id="pageText">1</b></div>
          </div>

          <div id="list" class="list"></div>

          <div id="listLoading" class="loading" style="display:none;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
          <div id="listError" class="error" style="display:none;"></div>
        </div>

        <div class="bottomBar">
          <button id="prevBtn" class="btn" type="button">ì´ì „</button>
          <button id="reloadBtn" class="btn" type="button">ìƒˆë¡œê³ ì¹¨</button>
          <button id="nextBtn" class="btn btnPrimary" type="button">ë‹¤ìŒ</button>
        </div>
      </section>

      <!-- DETAIL VIEW -->
      <section id="viewDetail" class="view" aria-label="ìƒì„¸">
        <div class="scroll" style="padding:0 0 calc(30px + var(--safe-bot));">
          <div class="hero">
            <img id="detailImg" class="heroImg" alt="" />
          </div>

          <div class="heroOverlay">
            <div class="detailCard">
              <div class="detailTitleRow">
                <h2 class="dTitle" id="dTitle">-</h2>
                <button id="favBtn" class="favBtn" type="button" title="ì°œ">â™¡</button>
              </div>

              <div class="kv">
                <div class="k">ì£¼ì†Œ</div>
                <div class="v" id="dAddr">-</div>
              </div>

              <div class="kv">
                <div class="k">ì†Œê°œ</div>
                <div class="v" id="dDesc">-</div>
              </div>

              <div class="kv">
                <div class="k">ëŒ€í‘œë©”ë‰´</div>
                <div class="v" id="dMenu">-</div>
              </div>

              <div class="kv">
                <div class="k">ë¬¸ì˜</div>
                <div class="v" id="dTel">-</div>
              </div>

              <div class="kv">
                <div class="k">ìš´ì˜ì‹œê°„</div>
                <div class="v" id="dTime">-</div>
              </div>

              <div class="mapWrap">
                <p class="mapTitle">ì§€ë„</p>
                <div id="map" class="map"></div>
              </div>

              <div style="display:flex; gap:8px; margin-top:12px;">
                <button id="copyAddrBtn" class="btn" type="button" style="flex:1;">ì£¼ì†Œ ë³µì‚¬</button>
                <button id="openKakaoMapBtn" class="btn btnPrimary" type="button" style="flex:1;">ì¹´ì¹´ì˜¤ë§µ ì—´ê¸°</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div id="toast" class="toast">ë³µì‚¬ë¨</div>
  </div>

  <script>
    // -------------------- Config --------------------
    const API_BASE = "https://apis.data.go.kr/6260000/FoodService/getFoodKr";

    // âœ… (ì„ íƒ) CORSê°€ ë§‰í˜€ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ í˜¸ì¶œì´ ì‹¤íŒ¨í•˜ë©´, í”„ë¡ì‹œë¥¼ í†µí•´ ìš°íšŒí•´ì•¼ í•©ë‹ˆë‹¤.
    // - ì•„ë˜ PROXY_PREFIXë¥¼ ë¹„ì›Œë‘ë©´("") ì§ì ‘ í˜¸ì¶œë§Œ ì‹œë„í•©ë‹ˆë‹¤.
    // - ì„ì‹œ ì˜ˆ: "https://corsproxy.io/?" (ì™¸ë¶€ ì„œë¹„ìŠ¤ëŠ” í™˜ê²½ì— ë”°ë¼ ë§‰í ìˆ˜ ìˆìŒ)
    const PROXY_PREFIX = "";

    // âœ… ê°œë°œ/ë””ìì¸ í™•ì¸ìš©: API í˜¸ì¶œì´ ì‹¤íŒ¨í•˜ë©´ ìƒ˜í”Œ ë°ì´í„°ë¡œ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
    let FORCE_SAMPLE_MODE = false;

    // âœ… ì—¬ê¸°ì— ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤(serviceKey)ë¥¼ ë„£ìœ¼ì„¸ìš”.
    // - Decoding í‚¤: ì½”ë“œê°€ ìë™ ì¸ì½”ë”©
    // - Encoding í‚¤(% í¬í•¨): ê·¸ëŒ€ë¡œ ì „ì†¡(ì´ì¤‘ ì¸ì½”ë”© ë°©ì§€)
    const SERVICE_KEY = "U3rjn1OQzoe833jk5RJokTl1sVFUmIQp7dGTZl0tcvNU7p2blLzjccSSgrAHQgyLYlBIm7Qt0wOFwQRvvG7h8Q==";

    let state = {
      pageNo: 1,
      numOfRows: 10,
      keyword: "",
      gugun: "",
      favOnly: false,
      items: [],
      totalCount: 0,
      selected: null
    };

    let kakaoMap = null;
    let kakaoMarker = null;

    const $ = (sel) => document.querySelector(sel);

    // Views
    const viewList = $("#viewList");
    const viewDetail = $("#viewDetail");
    const backBtn = $("#backBtn");
    const topTitle = $("#topTitle");
    const topSub = $("#topSub");
    const listControls = $("#listControls");

    // List elements
    const elList = $("#list");
    const elCount = $("#countText");
    const elPage = $("#pageText");
    const elLoading = $("#listLoading");
    const elError = $("#listError");

    const elSearchInput = $("#searchInput");
    const elSearchBtn = $("#searchBtn");
    const elGugun = $("#gugunSelect");
    const elRows = $("#rowsSelect");

    const elPrev = $("#prevBtn");
    const elNext = $("#nextBtn");
    const elReload = $("#reloadBtn");
    const elFavOnly = $("#toggleFavOnly");

    // Detail elements
    const elFav = $("#favBtn");
    const elImg = $("#detailImg");
    const elDTitle = $("#dTitle");
    const elDAddr = $("#dAddr");
    const elDDesc = $("#dDesc");
    const elDMenu = $("#dMenu");
    const elDTel = $("#dTel");
    const elDTime = $("#dTime");
    const elCopyAddr = $("#copyAddrBtn");
    const elOpenKakao = $("#openKakaoMapBtn");

    const toast = $("#toast");

    // Bootstrap (DOM + Kakao SDK)
    bootstrap();

    async function bootstrap() {
      if (document.readyState === "loading") {
        await new Promise((r) => document.addEventListener("DOMContentLoaded", r, { once: true }));
      }

      // ë’¤ë¡œê°€ê¸°ë¥¼ í™”ë©´ ì „í™˜ê³¼ ì—°ê²°
      window.addEventListener("popstate", () => {
        // state ì—†ì´ ë’¤ë¡œê°€ë©´ ëª©ë¡ìœ¼ë¡œ
        showList(false);
      });

      try {
        await ensureKakaoReady();
      } catch (e) {
        console.warn("Kakao Maps SDK not ready:", e);
      }

      init();
    }

    function init() {
      elRows.value = String(state.numOfRows);

      elSearchBtn.addEventListener("click", () => {
        state.keyword = (elSearchInput.value || "").trim();
        state.pageNo = 1;
        renderList();
      });

      elSearchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") elSearchBtn.click();
      });

      elRows.addEventListener("change", () => {
        state.numOfRows = Number(elRows.value);
        state.pageNo = 1;
        renderList();
      });

      elGugun.addEventListener("change", () => {
        state.gugun = elGugun.value;
        state.pageNo = 1;
        renderList();
      });

      elPrev.addEventListener("click", () => {
        if (state.pageNo > 1) {
          state.pageNo -= 1;
          renderList();
        }
      });

      elNext.addEventListener("click", () => {
        const lastPage = state.totalCount ? Math.ceil(state.totalCount / state.numOfRows) : state.pageNo + 1;
        if (state.pageNo < lastPage) {
          state.pageNo += 1;
          renderList();
        }
      });

      elReload.addEventListener("click", () => {
        renderList();
      });

      elFavOnly.addEventListener("click", () => {
        state.favOnly = !state.favOnly;
        elFavOnly.classList.toggle("btnPrimary", state.favOnly);
        state.pageNo = 1;
        renderList();
      });

      backBtn.addEventListener("click", () => {
        // ëª¨ë°”ì¼ UX: ë²„íŠ¼ì€ history.back()ê³¼ ë™ì¼í•˜ê²Œ
        history.back();
      });

      elFav.addEventListener("click", async () => {
        if (!state.selected) return;
        toggleFavorite(state.selected.UC_SEQ);
        await renderDetail(state.selected);
      });

      elCopyAddr.addEventListener("click", async () => {
        const addr = elDAddr.textContent || "";
        if (!addr || addr === "-") return toastMsg("ì£¼ì†Œê°€ ì—†ì–´ìš”");
        try {
          await navigator.clipboard.writeText(addr);
          toastMsg("ì£¼ì†Œê°€ ë³µì‚¬ëì–´ìš”");
        } catch {
          toastMsg("ë³µì‚¬ ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)");
        }
      });

      elOpenKakao.addEventListener("click", () => {
        if (!state.selected) return;
        const lat = Number(state.selected.LAT);
        const lng = Number(state.selected.LNG);
        const title = state.selected.MAIN_TITLE || "";
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
          return toastMsg("ì¢Œí‘œ ì •ë³´ê°€ ì—†ì–´ìš”");
        }
        // ì¹´ì¹´ì˜¤ë§µ ì›¹ ë§í¬(ëª¨ë°”ì¼ì—ì„œ ì•± ì—°ë™ë  ìˆ˜ ìˆìŒ)
        const url = `https://map.kakao.com/link/map/${encodeURIComponent(title)},${lat},${lng}`;
        window.open(url, "_blank", "noopener,noreferrer");
      });

      // ì´ˆê¸° í™”ë©´
      showList(false);
      renderList();
    }

    // -------------------- Navigation --------------------
    function showList(pushHistory = true) {
      topTitle.textContent = "ë¶€ì‚° ë§›ì§‘";
      topSub.textContent = "ë¶€ì‚°ê´‘ì—­ì‹œ_ë¶€ì‚° ë§›ì§‘ ì •ë³´";
      backBtn.style.display = "none";
      listControls.style.display = "block";

      viewDetail.classList.remove("is-active");
      viewList.classList.add("is-active");

      // ìƒì„¸ -> ëª©ë¡ìœ¼ë¡œ ê°ˆ ë•Œ ì§€ë„ ë¦¬ì†ŒìŠ¤ ì •ë¦¬(ì„ íƒ)
      // ì¹´ì¹´ì˜¤ë§µ ê°ì²´ëŠ” ì¬ì‚¬ìš©í•˜ë˜, í™”ë©´ì´ ë°”ë€Œë©´ relayoutë§Œ í•˜ë©´ ë¨.

      if (pushHistory) {
        history.pushState({ view: "list" }, "", "#list");
      }
    }

    function showDetail(pushHistory = true) {
      topTitle.textContent = "ìƒì„¸";
      topSub.textContent = "";
      backBtn.style.display = "inline-flex";
      listControls.style.display = "none";

      viewList.classList.add("is-exit-left");
      viewList.classList.remove("is-active");
      setTimeout(() => viewList.classList.remove("is-exit-left"), 220);

      viewDetail.classList.add("is-active");

      if (pushHistory) {
        history.pushState({ view: "detail" }, "", "#detail");
      }
    }

    // -------------------- List --------------------
    async function renderList() {
      setListStatus({ loading: true, error: "" });

      try {
        const data = await fetchFoodList(state.pageNo, state.numOfRows);
        const rawItems = normalizeItems(data);
        state.totalCount = Number(data?.getFoodKr?.totalCount || data?.totalCount || 0);

        fillGugunOptionsOnce(rawItems);

        const filtered = rawItems.filter((it) => {
          const matchesGugun = state.gugun ? (it.GUGUN_NM === state.gugun) : true;
          const matchesKeyword = state.keyword ? textBlob(it).includes(state.keyword.toLowerCase()) : true;
          const matchesFav = state.favOnly ? isFavorite(it.UC_SEQ) : true;
          return matchesGugun && matchesKeyword && matchesFav;
        });

        state.items = filtered;
        elCount.textContent = String(filtered.length);
        elPage.textContent = String(state.pageNo);

        elList.innerHTML = filtered.map(cardTemplate).join("");

        // Card click -> detail
        elList.querySelectorAll("[data-ucseq]").forEach((card) => {
          card.addEventListener("click", async (e) => {
            const target = e.target;
            if (target.closest("button")) return;

            const ucSeq = card.getAttribute("data-ucseq");
            await openDetail(ucSeq);
          });
        });

        // fav button
        elList.querySelectorAll("[data-fav]").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const ucSeq = btn.getAttribute("data-fav");
            toggleFavorite(ucSeq);
            btn.textContent = isFavorite(ucSeq) ? "â™¥" : "â™¡";
            toastMsg(isFavorite(ucSeq) ? "ì°œ ì¶”ê°€" : "ì°œ í•´ì œ");
          });
        });

        // map button -> open detail
        elList.querySelectorAll("[data-map]").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const ucSeq = btn.getAttribute("data-map");
            await openDetail(ucSeq);
          });
        });

        setListStatus({ loading: false, error: "" });
      } catch (err) {
        console.error(err);
        setListStatus({ loading: false, error: formatErr(err) + extraHelpForAuth(err) + extraHelpForCors(err) });
      }
    }

    function setListStatus({ loading, error }) {
      elLoading.style.display = loading ? "block" : "none";
      elError.style.display = error ? "block" : "none";

      if (!error) {
        elError.innerHTML = "";
        return;
      }

      elError.innerHTML = `
        <pre style="margin:0;white-space:pre-wrap;font-family:inherit;">${escapeHtml(error)}</pre>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="useSampleBtn" class="btn" type="button">ìƒ˜í”Œ ë°ì´í„°ë¡œ ë³´ê¸°</button>
          <button id="retryBtn" class="btn btnPrimary" type="button">ë‹¤ì‹œ ì‹œë„</button>
        </div>
      `;

      // ë²„íŠ¼ ë°”ì¸ë”©(ë§¤ë²ˆ ìƒˆë¡œ ê·¸ë ¤ì§€ë‹ˆ ì—¬ê¸°ì„œ 1íšŒ ë°”ì¸ë”©)
      const useSampleBtn = $("#useSampleBtn");
      const retryBtn = $("#retryBtn");

      useSampleBtn?.addEventListener("click", () => {
        FORCE_SAMPLE_MODE = true;
        state.pageNo = 1;
        renderList();
      });

      retryBtn?.addEventListener("click", () => {
        renderList();
      });
    }

    function cardTemplate(it) {
      const title = it.MAIN_TITLE || "ì´ë¦„ ì—†ìŒ";
      const addr = it.ADDR1 || "-";
      const menu = it.RPRSNTV_MENU || it.MENU || "-";
      const gugun = it.GUGUN_NM || "êµ¬/êµ°";
      const ucSeq = it.UC_SEQ;

      return `
        <div class="card" data-ucseq="${escapeHtml(String(ucSeq))}">
          <div>
            <div class="card__title">${escapeHtml(title)}</div>
            <p class="card__sub">ğŸ“ ${escapeHtml(addr)}</p>
            <p class="card__sub">ğŸ½ï¸ ${escapeHtml(menu)}</p>
            <div class="chips">
              <span class="chip">${escapeHtml(gugun)}</span>
            </div>
          </div>
          <div class="actions">
            <button class="heart" data-fav="${escapeHtml(String(ucSeq))}" title="ì°œ">${isFavorite(ucSeq) ? "â™¥" : "â™¡"}</button>
            <button class="mini" data-map="${escapeHtml(String(ucSeq))}" title="ìƒì„¸">â†—</button>
          </div>
        </div>
      `;
    }

    // -------------------- Detail --------------------
    async function openDetail(ucSeq) {
      try {
        const data = await fetchFoodDetail(ucSeq);
        const item = normalizeItems(data)[0] || state.items.find((x) => String(x.UC_SEQ) === String(ucSeq));
        if (!item) throw new Error("ìƒì„¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        state.selected = item;
        await renderDetail(item);
        showDetail(true);

        // ìƒì„¸ ìƒë‹¨ìœ¼ë¡œ
        viewDetail.querySelector(".scroll")?.scrollTo({ top: 0, behavior: "instant" });
      } catch (err) {
        console.error(err);
        toastMsg("ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨");
      }
    }

    async function renderDetail(item) {
      const imgUrl = item.MAIN_IMG_NORMAL || item.MAIN_IMG_THUMB || item.IMG_URL || item.MAIN_IMG || "";

      elImg.src = imgUrl || placeholderImage();
      elImg.alt = item.MAIN_TITLE || item.TITLE || "ë§›ì§‘ ì´ë¯¸ì§€";

      elDTitle.textContent = item.MAIN_TITLE || "-";
      elDAddr.textContent = item.ADDR1 || item.ADDR || "-";
      elDDesc.textContent = (item.ITEMCNTNTS || item.SUBTITLE || item.TITLE || "-").trim();
      elDMenu.textContent = item.RPRSNTV_MENU || item.MENU || "-";
      elDTel.textContent = item.CNTCT_TEL || item.TEL || "-";
      elDTime.textContent = item.USAGE_DAY_WEEK_AND_TIME || item.USAGE_TIME || "-";

      elFav.textContent = isFavorite(item.UC_SEQ) ? "â™¥" : "â™¡";

      const lat = Number(item.LAT);
      const lng = Number(item.LNG);
      if (Number.isFinite(lat) && Number.isFinite(lng)) {
        await renderKakaoMap(lat, lng, item.MAIN_TITLE || "ì„ íƒí•œ ìœ„ì¹˜");
      } else {
        $("#map").innerHTML = `<div style="padding:12px;color:var(--muted);">ì¢Œí‘œ ì •ë³´(LAT/LNG)ê°€ ì—†ì–´ ì§€ë„ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ì–´ìš”.</div>`;
      }
    }

    // -------------------- API --------------------
    async function fetchFoodList(pageNo, numOfRows) {
      if (FORCE_SAMPLE_MODE) return sampleResponse(pageNo, numOfRows);

      const directUrl = buildUrl({ serviceKey: SERVICE_KEY, pageNo, numOfRows, resultType: "json" });
      const url = PROXY_PREFIX ? (PROXY_PREFIX + directUrl) : directUrl;

      let res;
      try {
        res = await fetch(url);
      } catch (e) {
        const err = new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜(ë˜ëŠ” CORS ì°¨ë‹¨)ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        err.name = e?.name || "TypeError";
        err.status = undefined;
        err.url = directUrl;
        throw err;
      }

      if (!res.ok) {
        const body = await safeReadText(res);
        const err = new Error(`HTTP ${res.status}`);
        err.status = res.status;
        err.url = directUrl;
        err.body = body;
        throw err;
      }

      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch {
        const err = new Error("ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨");
        err.status = 0;
        err.url = directUrl;
        err.body = text;
        throw err;
      }
    }

    async function fetchFoodDetail(ucSeq) {
      if (FORCE_SAMPLE_MODE) {
        const found = SAMPLE_ITEMS.find((x) => String(x.UC_SEQ) === String(ucSeq));
        return { getFoodKr: { item: found ? [found] : [] } };
      }

      const directUrl = buildUrl({ serviceKey: SERVICE_KEY, pageNo: 1, numOfRows: 1, resultType: "json", UC_SEQ: ucSeq });
      const url = PROXY_PREFIX ? (PROXY_PREFIX + directUrl) : directUrl;

      let res;
      try {
        res = await fetch(url);
      } catch (e) {
        const err = new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜(ë˜ëŠ” CORS ì°¨ë‹¨)ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        err.name = e?.name || "TypeError";
        err.status = undefined;
        err.url = directUrl;
        throw err;
      }

      if (!res.ok) {
        const body = await safeReadText(res);
        const err = new Error(`HTTP ${res.status}`);
        err.status = res.status;
        err.url = directUrl;
        err.body = body;
        throw err;
      }

      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch {
        const err = new Error("ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨");
        err.status = 0;
        err.url = directUrl;
        err.body = text;
        throw err;
      }
    }

    function buildUrl(params) {
      const { serviceKey, ...rest } = params;
      const usp = new URLSearchParams();
      Object.entries(rest).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== "") usp.append(k, String(v));
      });
      const sk = normalizeServiceKey(serviceKey);
      const qs = usp.toString();
      return `${API_BASE}?serviceKey=${sk}${qs ? `&${qs}` : ""}`;
    }

    function normalizeServiceKey(key) {
      if (!key) return "";
      if (/%[0-9A-Fa-f]{2}/.test(key)) return key; // Encoding key
      return encodeURIComponent(key); // Decoding key
    }

    function normalizeItems(data) {
      const root = data?.getFoodKr || data?.response?.body || data;
      const items = root?.item || root?.items || root?.body?.items || root?.body?.item || [];
      if (Array.isArray(items)) return items;
      if (items && typeof items === "object") return [items];
      return [];
    }

    function textBlob(it) {
      return [it.MAIN_TITLE, it.ADDR1, it.RPRSNTV_MENU, it.TITLE, it.SUBTITLE, it.GUGUN_NM]
        .filter(Boolean)
        .join(" ")
        .toLowerCase();
    }

    function fillGugunOptionsOnce(items) {
      if (elGugun.options.length > 1) return;
      const set = new Set(items.map((x) => x.GUGUN_NM).filter(Boolean));
      [...set].sort().forEach((g) => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        elGugun.appendChild(opt);
      });
    }

    // -------------------- Favorites --------------------
    const FAV_KEY = "busan_food_favs_v1";

    function getFavSet() {
      try {
        const raw = localStorage.getItem(FAV_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(arr.map(String));
      } catch {
        return new Set();
      }
    }

    function saveFavSet(set) {
      localStorage.setItem(FAV_KEY, JSON.stringify([...set]));
    }

    function isFavorite(ucSeq) {
      return getFavSet().has(String(ucSeq));
    }

    function toggleFavorite(ucSeq) {
      const set = getFavSet();
      const key = String(ucSeq);
      if (set.has(key)) set.delete(key);
      else set.add(key);
      saveFavSet(set);

      // ëª©ë¡ í™”ë©´ì¼ ë•Œ ì°œë§Œë³´ê¸° ì¤‘ì´ë©´ ì¦‰ì‹œ ê°±ì‹ 
      if (state.favOnly) renderList();
    }

    // -------------------- Kakao Map --------------------
    async function renderKakaoMap(lat, lng, title) {
      const container = $("#map");

      try {
        await ensureKakaoReady();
      } catch {
        container.innerHTML = `<div style="padding:12px;color:var(--muted);">ì¹´ì¹´ì˜¤ë§µ SDKê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.<br/>- appkey í™•ì¸<br/>- ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†”ì—ì„œ <b>í”Œë«í¼(Web) ë„ë©”ì¸</b> ë“±ë¡ í™•ì¸</div>`;
        return;
      }

      await new Promise((r) => requestAnimationFrame(r));
      const pos = new kakao.maps.LatLng(lat, lng);

      if (!kakaoMap) {
        kakaoMap = new kakao.maps.Map(container, { center: pos, level: 3 });
        kakaoMarker = new kakao.maps.Marker({ position: pos });
        kakaoMarker.setMap(kakaoMap);
      } else {
        kakaoMap.relayout();
        kakaoMap.setCenter(pos);
        kakaoMarker.setPosition(pos);
      }

      const iwContent = `<div style="padding:6px 8px;font-size:12px;">${escapeHtml(title)}</div>`;
      const iw = new kakao.maps.InfoWindow({ content: iwContent });
      iw.open(kakaoMap, kakaoMarker);
    }

    function ensureKakaoReady() {
      return new Promise((resolve, reject) => {
        if (window.kakao && window.kakao.maps) {
          try {
            window.kakao.maps.load(() => resolve());
          } catch {
            resolve();
          }
          return;
        }

        const started = Date.now();
        const timer = setInterval(() => {
          if (window.kakao && window.kakao.maps) {
            clearInterval(timer);
            try {
              window.kakao.maps.load(() => resolve());
            } catch {
              resolve();
            }
          } else if (Date.now() - started > 5000) {
            clearInterval(timer);
            reject(new Error("Kakao SDK load timeout"));
          }
        }, 50);
      });
    }

    // -------------------- Utils --------------------
    function placeholderImage() {
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
          <rect width="100%" height="100%" fill="#020617"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            fill="#94a3b8" font-size="36" font-family="Arial">ì´ë¯¸ì§€ ì—†ìŒ</text>
        </svg>
      `);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatErr(err) {
      if (typeof err === "string") return err;
      if (!err) return "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";

      const status = err.status ? ` (status: ${err.status})` : "";
      let msg = err.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
      msg += status;

      if (err.url) {
        msg += `
ìš”ì²­ URL: ${maskServiceKey(err.url)}`;
      }
      if (err.body) {
        msg += `

ì‘ë‹µ: ${String(err.body).slice(0, 500)}`;
      }
      return msg;
    }

    function extraHelpForAuth(err) {
      if (err && Number(err.status) === 401) {
        return `

[í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸]
1) serviceKey í™•ì¸ (ê³µê³µë°ì´í„°í¬í„¸ > ë§ˆì´í˜ì´ì§€ > ì¸ì¦í‚¤)
2) Encoding í‚¤(% í¬í•¨)ë¥¼ ë„£ì—ˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©(ì´ì¤‘ ì¸ì½”ë”© ê¸ˆì§€)
3) Decoding í‚¤ë¼ë©´ ìë™ ì¸ì½”ë”©ë©ë‹ˆë‹¤
4) í‚¤ ì•ë’¤ ê³µë°±/ì¤„ë°”ê¿ˆ ì œê±°

â€» ì—¬ì „íˆ 401ì´ë©´, í•´ë‹¹ API 'í™œìš©ì‹ ì²­/ìŠ¹ì¸ ìƒíƒœ'ë„ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
      }
      return "";
    }

    function extraHelpForCors(err) {
      const isFailedFetch = err && err.name === "TypeError" && /cors|fetch|network/i.test(err.message || "");
      const isNoStatus = err && (err.status === undefined || err.status === null);

      if (isFailedFetch || isNoStatus) {
        return `

[ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•¨ (CORS ê°€ëŠ¥ì„±)]
- ë¸Œë¼ìš°ì €ì—ì„œ ê³µê³µë°ì´í„° OpenAPI ì§ì ‘ í˜¸ì¶œì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- í•´ê²°: í”„ë¡ì‹œ í•„ìš”
  1) ì•ˆì •ì : ë³¸ì¸ ì„œë²„/ì„œë²„ë¦¬ìŠ¤(Worker ë“±)ì— í”„ë¡ì‹œ 1ê°œ
  2) ì„ì‹œ: PROXY_PREFIXì— í”„ë¡ì‹œ ì£¼ì†Œ ì…ë ¥

â€» ì•„ë˜ 'ìƒ˜í”Œ ë°ì´í„°ë¡œ ë³´ê¸°'ë¡œ UIë¥¼ ë¨¼ì € í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.`;
      }
      return "";
    }

    function maskServiceKey(url) {
      try {
        const u = new URL(url);
        const sk = u.searchParams.get("serviceKey");
        if (!sk) return url;
        const tail = sk.slice(-4);
        u.searchParams.set("serviceKey", `****${tail}`);
        return u.toString();
      } catch {
        return url;
      }
    }

    async function safeReadText(res) {
      try {
        return await res.text();
      } catch {
        return "";
      }
    }

    function toastMsg(message) {
      toast.textContent = message;
      toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => toast.classList.remove("show"), 1200);
    }

    // -------------------- Sample Data --------------------
    const SAMPLE_ITEMS = [
      {
        UC_SEQ: 1,
        MAIN_TITLE: "ë§Œë“œë¦¬ê³¤ë“œë ˆë°¥",
        GUGUN_NM: "ê°•ì„œêµ¬",
        ADDR1: "ë¶€ì‚° ê°•ì„œêµ¬ ê³µí•­ì•ê¸¸ 85ë²ˆê¸¸ 13",
        RPRSNTV_MENU: "ëŒì†¥ê³¤ë“œë ˆì •ì‹, ë‹¨í˜¸ë°•ì˜¤ë¦¬í›ˆì œ",
        ITEMCNTNTS: "ìƒ ê³¤ë“œë ˆë‚˜ë¬¼ì„ ì‚¬ìš©í•œ ëŒì†¥ë°¥ê³¼ ë‹¤ì–‘í•œ ë°˜ì°¬ì´ ì¸ê¸°ì…ë‹ˆë‹¤.",
        CNTCT_TEL: "051-941-3669",
        USAGE_DAY_WEEK_AND_TIME: "11:00-21:00 (20:00 ë¼ìŠ¤íŠ¸ì˜¤ë”)",
        MAIN_IMG_NORMAL: "",
        LAT: 35.1765,
        LNG: 128.9477
      },
      {
        UC_SEQ: 2,
        MAIN_TITLE: "ê°€ì•¼í• ë§¤ë°€ë©´",
        GUGUN_NM: "ë¶€ì‚°ì§„êµ¬",
        ADDR1: "ë¶€ì‚° ë¶€ì‚°ì§„êµ¬ ì›”ë“œì»µëŒ€ë¡œ 145ë²ˆê¸¸ 32",
        RPRSNTV_MENU: "ë¬¼ë°€ë©´, ë¹„ë¹”ë°€ë©´",
        ITEMCNTNTS: "ë¶€ì‚° ëŒ€í‘œ ë°€ë©´ ë§›ì§‘ìœ¼ë¡œ ì•Œë ¤ì ¸ ìˆìŠµë‹ˆë‹¤.",
        CNTCT_TEL: "-",
        USAGE_DAY_WEEK_AND_TIME: "-",
        MAIN_IMG_NORMAL: "",
        LAT: 35.1598,
        LNG: 129.0564
      },
      {
        UC_SEQ: 3,
        MAIN_TITLE: "ê±°ì¸í†µë‹­",
        GUGUN_NM: "ì¤‘êµ¬",
        ADDR1: "ë¶€ì‚° ì¤‘êµ¬ ì¤‘êµ¬ë¡œ47ë²ˆê¸¸ 34",
        RPRSNTV_MENU: "í›„ë¼ì´ë“œì¹˜í‚¨",
        ITEMCNTNTS: "ì „í†µì‹œì¥ ê°ì„±ì˜ í†µë‹­ ë§›ì§‘ìœ¼ë¡œ ìœ ëª…í•©ë‹ˆë‹¤.",
        CNTCT_TEL: "-",
        USAGE_DAY_WEEK_AND_TIME: "-",
        MAIN_IMG_NORMAL: "",
        LAT: 35.1065,
        LNG: 129.0322
      }
    ];

    function sampleResponse(pageNo, numOfRows) {
      const start = (pageNo - 1) * numOfRows;
      const slice = SAMPLE_ITEMS.slice(start, start + numOfRows);
      return { getFoodKr: { totalCount: SAMPLE_ITEMS.length, item: slice } };
    }
  </script>
</body>
</html>
